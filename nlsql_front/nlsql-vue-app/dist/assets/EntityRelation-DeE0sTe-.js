import{_ as he,f as Ce,c as T,a as i,b as t,w as a,J as xe,g as qe,h as I,t as u,E as b,m as M,r as d,j as v,k as ze,o as x,u as Y,s as Ue,F as Z,x as ee,n as _,p as De,i as Fe,v as te}from"./index-CPm_9BR3.js";import{a as Ne,b as Re,c as le,d as Te,u as Se,e as $e}from"./tableFieldRelation-DjRPEoda.js";import{g as Be}from"./nlsqlTaskConfig-vN1Wt6V1.js";import"./index-DefhRm7t.js";const Le={class:"table-metadata-view"},Ee={class:"card search-card"},Ie={class:"search-section"},Me={class:"card table-card"},Pe={class:"table-container"},Ke={class:"compact-pagination"},Oe={class:"pagination-content"},je={class:"record-count"},Ae={key:0,class:"view-detail-wrap"},Je={class:"relation-summary"},Ge={class:"relation-visual-panel"},He={class:"table-box source-box"},Qe={class:"table-name"},We={class:"field-chip"},Xe={class:"relation-bridge"},Ye={class:"relation-type-pill"},Ze={class:"table-box target-box"},et={class:"table-name"},tt={class:"field-chip"},lt={class:"description-card"},at={class:"description-content"},ot={__name:"EntityRelation",setup(nt){const S=v(!1),$=v(!1),B=v([]),L=v([]),h=v([]),P=v(null),q=v(!1),F=v(!1),U=v(!1),D=v(null),g=v(null),p=M({table_name:"",task_id:null}),s=M({page:1,page_size:10,total:0}),l=M({id:null,nlsql_task_id:null,source_table_field_prompt_id:null,source_table_level_prompt_id:null,source_table_name:"",source_field_name:"",target_table_field_prompt_id:null,target_table_level_prompt_id:null,target_table_name:"",target_field_name:"",relation_type:"",relation_description:"",confidence:""}),ae={nlsql_task_id:[{required:!0,message:"请选择任务",trigger:"change"}],relation_type:[{required:!0,message:"请输入关联类型",trigger:"blur"}],source_table_name:[{required:!0,message:"请输入源表名",trigger:"blur"}],source_field_name:[{required:!0,message:"请输入源字段名",trigger:"blur"}],target_table_name:[{required:!0,message:"请输入目标表名",trigger:"blur"}],target_field_name:[{required:!0,message:"请输入目标字段名",trigger:"blur"}]};async function oe(){try{const o=await Be({page:1,page_size:100});L.value=o.items||o.data||[]}catch(o){console.error("获取任务列表失败:",o),b.error("获取任务列表失败")}}async function w(){try{S.value=!0;const o={page:s.page,page_size:s.page_size};p.table_name&&(o.table_name=p.table_name),p.task_id&&(o.task_id=p.task_id);const e=await Ne(o);B.value=e.data||e.items||[],s.total=e.pagination?.total||e.total||0,h.value=[],P.value?.clearSelection()}catch(o){console.error("获取实体关系列表失败:",o),b.error("获取实体关系列表失败")}finally{S.value=!1}}function K(){s.page=1,w()}function ne(){p.table_name="",p.task_id=null,s.page=1,w()}function ie(){s.page=1,w()}function re(o){h.value=o}function se(o){s.page_size=o,s.page=1,w()}function de(o){s.page=o,w()}async function O(){await w(),B.value.length===0&&s.page>1&&(s.page-=1,await w())}function _e(){U.value=!1,J(),p.task_id&&(l.nlsql_task_id=p.task_id),q.value=!0}async function ue(o){try{U.value=!0;const e=await le(o.id),r=e.data||e;l.id=r.id,l.nlsql_task_id=r.nlsql_task_id,l.source_table_field_prompt_id=r.source_table_field_prompt_id||null,l.source_table_level_prompt_id=r.source_table_level_prompt_id||null,l.source_table_name=r.source_table_name||"",l.source_field_name=r.source_field_name||"",l.target_table_field_prompt_id=r.target_table_field_prompt_id||null,l.target_table_level_prompt_id=r.target_table_level_prompt_id||null,l.target_table_name=r.target_table_name||"",l.target_field_name=r.target_field_name||"",l.relation_type=r.relation_type||"",l.relation_description=r.relation_description||"",l.confidence=r.confidence||"",q.value=!0}catch(e){console.error("获取实体关系详情失败:",e),b.error("获取实体关系详情失败")}}async function pe(o){try{const e=await le(o.id);g.value=e.data||e,F.value=!0}catch(e){console.error("获取实体关系详情失败:",e),b.error("获取实体关系详情失败")}}async function me(o){try{await te.confirm(`确定删除实体关系 #${o.id} 吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Te(o.id),b.success("删除成功"),await O()}catch(e){e!=="cancel"&&(console.error("删除实体关系失败:",e),b.error(e.response?.data?.detail||"删除失败"))}}async function ce(){if(h.value.length===0){b.warning("请选择要删除的记录");return}try{await te.confirm(`确定删除选中的 ${h.value.length} 条记录吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const o=h.value.map(e=>e.id).filter(e=>Number.isFinite(e));await Re(o),b.success("批量删除成功"),await O()}catch(o){o!=="cancel"&&(console.error("批量删除失败:",o),b.error(o.response?.data?.detail||"批量删除失败"))}}async function fe(){if(D.value)try{if(await D.value.validate(),$.value=!0,U.value){const o=ge();await Se(l.id,o),b.success("更新成功")}else{const o=be();await $e(o),b.success("创建成功")}q.value=!1,await w()}catch(o){console.error("保存实体关系失败:",o),b.error(o.response?.data?.detail||o.message||"保存失败")}finally{$.value=!1}}function be(){return{nlsql_task_id:Number(l.nlsql_task_id),source_table_field_prompt_id:V(l.source_table_field_prompt_id),source_table_level_prompt_id:V(l.source_table_level_prompt_id),source_table_name:m(l.source_table_name),source_field_name:m(l.source_field_name),target_table_field_prompt_id:V(l.target_table_field_prompt_id),target_table_level_prompt_id:V(l.target_table_level_prompt_id),target_table_name:m(l.target_table_name),target_field_name:m(l.target_field_name),relation_type:m(l.relation_type),relation_description:m(l.relation_description),confidence:j(l.confidence)}}function ge(){return{source_table_field_prompt_id:V(l.source_table_field_prompt_id),source_table_level_prompt_id:V(l.source_table_level_prompt_id),source_table_name:m(l.source_table_name),source_field_name:m(l.source_field_name),target_table_field_prompt_id:V(l.target_table_field_prompt_id),target_table_level_prompt_id:V(l.target_table_level_prompt_id),target_table_name:m(l.target_table_name),target_field_name:m(l.target_field_name),relation_type:m(l.relation_type),relation_description:m(l.relation_description),confidence:j(l.confidence)}}function m(o){return(o||"").trim()||null}function V(o){if(o==null||o==="")return null;const e=Number(o);return Number.isFinite(e)?e:null}function j(o){const e=(o||"").toString().trim();if(!e)return null;const r=Number(e);return Number.isFinite(r)?r<0?"0":r>1?"1":r.toString():e}function A(o){if(o==null||o==="")return"-";const e=Number(o);return Number.isFinite(e)?`${Math.round(e*100)}%`:String(o)}function J(){l.id=null,l.nlsql_task_id=null,l.source_table_field_prompt_id=null,l.source_table_level_prompt_id=null,l.source_table_name="",l.source_field_name="",l.target_table_field_prompt_id=null,l.target_table_level_prompt_id=null,l.target_table_name="",l.target_field_name="",l.relation_type="",l.relation_description="",l.confidence="",D.value&&D.value.resetFields()}function ve(o){return o?new Date(o).toLocaleString("zh-CN"):"-"}return Ce(async()=>{await oe(),await w()}),(o,e)=>{const r=d("el-icon"),k=d("el-input"),G=d("el-option"),H=d("el-select"),C=d("el-button"),y=d("el-table-column"),N=d("el-tag"),E=d("el-link"),Q=d("el-divider"),ye=d("el-table"),we=d("el-pagination"),c=d("el-form-item"),f=d("el-col"),z=d("el-row"),R=d("el-input-number"),Ve=d("el-form"),W=d("el-dialog"),ke=ze("loading");return x(),T("div",Le,[i("div",Ee,[e[23]||(e[23]=i("h2",{class:"card-title"},"实体关系",-1)),e[24]||(e[24]=i("p",{class:"page-desc"},"管理两张表之间的字段关联关系，支持按表名和任务筛选、分页查询、增删改查",-1)),i("div",Ie,[t(k,{modelValue:p.table_name,"onUpdate:modelValue":e[0]||(e[0]=n=>p.table_name=n),placeholder:"搜索表名",clearable:"",class:"search-input",onKeyup:xe(K,["enter"])},{prefix:a(()=>[t(r,null,{default:a(()=>[t(Y(Ue))]),_:1})]),_:1},8,["modelValue"]),t(H,{modelValue:p.task_id,"onUpdate:modelValue":e[1]||(e[1]=n=>p.task_id=n),placeholder:"选择任务",clearable:"",class:"task-select",onChange:ie},{default:a(()=>[(x(!0),T(Z,null,ee(L.value,n=>(x(),I(G,{key:n.id,label:`${n.id} - ${n.description||"无描述"}`,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(C,{type:"primary",onClick:K},{default:a(()=>[...e[20]||(e[20]=[_("查询",-1)])]),_:1}),t(C,{onClick:ne},{default:a(()=>[...e[21]||(e[21]=[_("重置",-1)])]),_:1}),t(C,{type:"primary",onClick:_e},{default:a(()=>[t(r,null,{default:a(()=>[t(Y(De))]),_:1}),e[22]||(e[22]=_(" 新增 ",-1))]),_:1}),t(C,{type:"danger",disabled:h.value.length===0,onClick:ce},{default:a(()=>[_(" 批量删除 ("+u(h.value.length)+") ",1)]),_:1},8,["disabled"])])]),i("div",Me,[i("div",Pe,[qe((x(),I(ye,{ref_key:"tableRef",ref:P,data:B.value,style:{width:"100%"},onSelectionChange:re},{default:a(()=>[t(y,{type:"selection",width:"55"}),t(y,{prop:"id",label:"ID",width:"90"}),t(y,{prop:"source_table_name",label:"源表","min-width":"140","show-overflow-tooltip":""}),t(y,{prop:"source_field_name",label:"源字段","min-width":"140","show-overflow-tooltip":""}),t(y,{prop:"target_table_name",label:"目标表","min-width":"140","show-overflow-tooltip":""}),t(y,{prop:"target_field_name",label:"目标字段","min-width":"140","show-overflow-tooltip":""}),t(y,{prop:"relation_type",label:"关联类型",width:"120","show-overflow-tooltip":""}),t(y,{label:"置信度",width:"120"},{default:a(n=>[t(N,{type:"success",effect:"plain"},{default:a(()=>[_(u(A(n.row.confidence)),1)]),_:2},1024)]),_:1}),t(y,{prop:"created_at",label:"创建时间",width:"180"},{default:a(n=>[_(u(ve(n.row.created_at)),1)]),_:1}),t(y,{label:"操作",width:"190",fixed:"right"},{default:a(n=>[t(E,{type:"primary",onClick:X=>pe(n.row)},{default:a(()=>[...e[25]||(e[25]=[_("查看",-1)])]),_:1},8,["onClick"]),t(Q,{direction:"vertical"}),t(E,{type:"primary",onClick:X=>ue(n.row)},{default:a(()=>[...e[26]||(e[26]=[_("编辑",-1)])]),_:1},8,["onClick"]),t(Q,{direction:"vertical"}),t(E,{type:"danger",onClick:X=>me(n.row)},{default:a(()=>[...e[27]||(e[27]=[_("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ke,S.value]])])]),i("div",Ke,[i("div",Oe,[i("span",je,"共 "+u(s.total)+" 条",1),t(we,{"current-page":s.page,"onUpdate:currentPage":e[2]||(e[2]=n=>s.page=n),"page-size":s.page_size,"onUpdate:pageSize":e[3]||(e[3]=n=>s.page_size=n),total:s.total,"page-sizes":[10,20,50,100],size:"small",layout:"prev, pager, next, sizes",background:!1,onSizeChange:se,onCurrentChange:de},null,8,["current-page","page-size","total"])])]),t(W,{modelValue:q.value,"onUpdate:modelValue":e[17]||(e[17]=n=>q.value=n),title:U.value?"编辑实体关系":"新增实体关系",width:"960px",onClose:J},{footer:a(()=>[t(C,{onClick:e[16]||(e[16]=n=>q.value=!1)},{default:a(()=>[...e[28]||(e[28]=[_("取消",-1)])]),_:1}),t(C,{type:"primary",loading:$.value,onClick:fe},{default:a(()=>[...e[29]||(e[29]=[_("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[t(Ve,{ref_key:"formRef",ref:D,model:l,rules:ae,"label-width":"140px"},{default:a(()=>[t(z,{gutter:16},{default:a(()=>[t(f,{span:12},{default:a(()=>[t(c,{label:"任务ID",prop:"nlsql_task_id"},{default:a(()=>[t(H,{modelValue:l.nlsql_task_id,"onUpdate:modelValue":e[4]||(e[4]=n=>l.nlsql_task_id=n),placeholder:"请选择任务",style:{width:"100%"},disabled:U.value},{default:a(()=>[(x(!0),T(Z,null,ee(L.value,n=>(x(),I(G,{key:n.id,label:`${n.id} - ${n.description||"无描述"}`,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),t(f,{span:12},{default:a(()=>[t(c,{label:"关联类型",prop:"relation_type"},{default:a(()=>[t(k,{modelValue:l.relation_type,"onUpdate:modelValue":e[5]||(e[5]=n=>l.relation_type=n),placeholder:"例如：foreign_key / business_key"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(z,{gutter:16},{default:a(()=>[t(f,{span:12},{default:a(()=>[t(c,{label:"源表名",prop:"source_table_name"},{default:a(()=>[t(k,{modelValue:l.source_table_name,"onUpdate:modelValue":e[6]||(e[6]=n=>l.source_table_name=n),placeholder:"例如：orders"},null,8,["modelValue"])]),_:1})]),_:1}),t(f,{span:12},{default:a(()=>[t(c,{label:"源字段名",prop:"source_field_name"},{default:a(()=>[t(k,{modelValue:l.source_field_name,"onUpdate:modelValue":e[7]||(e[7]=n=>l.source_field_name=n),placeholder:"例如：user_id"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(z,{gutter:16},{default:a(()=>[t(f,{span:12},{default:a(()=>[t(c,{label:"目标表名",prop:"target_table_name"},{default:a(()=>[t(k,{modelValue:l.target_table_name,"onUpdate:modelValue":e[8]||(e[8]=n=>l.target_table_name=n),placeholder:"例如：users"},null,8,["modelValue"])]),_:1})]),_:1}),t(f,{span:12},{default:a(()=>[t(c,{label:"目标字段名",prop:"target_field_name"},{default:a(()=>[t(k,{modelValue:l.target_field_name,"onUpdate:modelValue":e[9]||(e[9]=n=>l.target_field_name=n),placeholder:"例如：id"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(z,{gutter:16},{default:a(()=>[t(f,{span:12},{default:a(()=>[t(c,{label:"置信度(0-1)"},{default:a(()=>[t(k,{modelValue:l.confidence,"onUpdate:modelValue":e[10]||(e[10]=n=>l.confidence=n),placeholder:"例如：0.85"},null,8,["modelValue"])]),_:1})]),_:1}),t(f,{span:12},{default:a(()=>[t(c,{label:"源表提示词ID"},{default:a(()=>[t(R,{modelValue:l.source_table_level_prompt_id,"onUpdate:modelValue":e[11]||(e[11]=n=>l.source_table_level_prompt_id=n),min:1,controls:!1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(z,{gutter:16},{default:a(()=>[t(f,{span:12},{default:a(()=>[t(c,{label:"目标表提示词ID"},{default:a(()=>[t(R,{modelValue:l.target_table_level_prompt_id,"onUpdate:modelValue":e[12]||(e[12]=n=>l.target_table_level_prompt_id=n),min:1,controls:!1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),t(f,{span:12},{default:a(()=>[t(c,{label:"源字段提示词ID"},{default:a(()=>[t(R,{modelValue:l.source_table_field_prompt_id,"onUpdate:modelValue":e[13]||(e[13]=n=>l.source_table_field_prompt_id=n),min:1,controls:!1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(z,{gutter:16},{default:a(()=>[t(f,{span:12},{default:a(()=>[t(c,{label:"目标字段提示词ID"},{default:a(()=>[t(R,{modelValue:l.target_table_field_prompt_id,"onUpdate:modelValue":e[14]||(e[14]=n=>l.target_table_field_prompt_id=n),min:1,controls:!1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),t(f,{span:12})]),_:1}),t(c,{label:"关联描述"},{default:a(()=>[t(k,{modelValue:l.relation_description,"onUpdate:modelValue":e[15]||(e[15]=n=>l.relation_description=n),type:"textarea",rows:3,placeholder:"请输入两张表字段之间的关联说明"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(W,{modelValue:F.value,"onUpdate:modelValue":e[19]||(e[19]=n=>F.value=n),title:"实体关系可视化",width:"980px"},{footer:a(()=>[t(C,{onClick:e[18]||(e[18]=n=>F.value=!1)},{default:a(()=>[...e[34]||(e[34]=[_("关闭",-1)])]),_:1})]),default:a(()=>[g.value?(x(),T("div",Ae,[i("div",Je,[t(N,{type:"primary",effect:"dark"},{default:a(()=>[_("任务 "+u(g.value.nlsql_task_id),1)]),_:1}),t(N,{type:"success",effect:"plain"},{default:a(()=>[_(u(g.value.relation_type||"未定义类型"),1)]),_:1}),t(N,{type:"warning",effect:"plain"},{default:a(()=>[_("置信度 "+u(A(g.value.confidence)),1)]),_:1})]),i("div",Ge,[i("div",He,[e[30]||(e[30]=i("div",{class:"table-title"},"源表",-1)),i("div",Qe,u(g.value.source_table_name||"-"),1),i("div",We,u(g.value.source_field_name||"-"),1)]),i("div",Xe,[i("div",Ye,u(g.value.relation_type||"relation"),1),e[31]||(e[31]=i("div",{class:"relation-line"},[i("span",{class:"line"}),i("span",{class:"arrow"},"→")],-1))]),i("div",Ze,[e[32]||(e[32]=i("div",{class:"table-title"},"目标表",-1)),i("div",et,u(g.value.target_table_name||"-"),1),i("div",tt,u(g.value.target_field_name||"-"),1)])]),i("div",lt,[e[33]||(e[33]=i("div",{class:"description-title"},"关系说明",-1)),i("div",at,u(g.value.relation_description||"暂无关系说明"),1)])])):Fe("",!0)]),_:1},8,["modelValue"])])}}},_t=he(ot,[["__scopeId","data-v-048ec70b"]]);export{_t as default};
