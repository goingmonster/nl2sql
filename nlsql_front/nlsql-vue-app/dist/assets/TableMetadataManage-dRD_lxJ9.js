import{_ as se,f as re,c as T,a as b,b as e,w as t,g as ue,h as z,E as c,r as i,j as g,k as _e,m as $,y as ce,o as v,u as A,q as pe,n,z as me,F as O,x as j,s as fe,t as u,i as G,v as W}from"./index-CPm_9BR3.js";import{g as be,e as ge,f as ve,h as ye,a as we}from"./tableMetadata-BYn0U9Y9.js";import"./index-DefhRm7t.js";const he={class:"table-metadata-container"},Ve={class:"table-metadata-header"},xe={class:"header-actions"},Ce={class:"filter-section"},Te={class:"table-section"},ke={class:"pagination"},De={key:0},Be={key:0,class:"table-ddl"},Le={__name:"TableMetadataManage",setup(Me){const D=g(!1),B=g(!1),x=g(!1),L=g(!1),r=g(null),C=g([]),M=g([]),F=g([]),d=$({db_config_id:null,table_name:"",table_type:"",min_row_count:null,max_row_count:null,order_by:"created_at",order_direction:"desc"}),w=$({db_config_id:null}),s=$({skip:0,limit:20,total:0}),q=ce(()=>Math.floor(s.skip/s.limit)+1),P=async()=>{try{const o=await be({page:1,page_size:100});M.value=o.items||[]}catch(o){console.error("获取数据库配置失败:",o),c.error("获取数据库配置失败")}},p=async()=>{D.value=!0;try{const o={...d,skip:s.skip,limit:s.limit};Object.keys(o).forEach(m=>{(o[m]===""||o[m]===null||o[m]===void 0)&&delete o[m]});const l=await ge(o);F.value=l.items||[],s.total=l.total||0}catch(o){console.error("获取表元数据失败:",o),c.error("获取表元数据失败")}finally{D.value=!1}},H=o=>{C.value=o.map(l=>l.id)},J=()=>{w.db_config_id=null,x.value=!0},K=async()=>{if(!w.db_config_id){c.error("请选择数据库配置");return}B.value=!0;try{await we({db_config_id:w.db_config_id}),c.success("表元数据扫描成功"),x.value=!1,p()}catch(o){console.error("扫描表元数据失败:",o),c.error("扫描表元数据失败")}finally{B.value=!1}},Q=o=>{r.value=o,L.value=!0},R=o=>{W.confirm(`确定要删除表 "${o.table_name}" 的元数据吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ye(o.id),c.success("删除成功"),p()}catch(l){console.error("删除失败:",l),c.error("删除失败")}})},X=()=>{W.confirm(`确定要删除选中的 ${C.value.length} 条表元数据吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ve({ids:C.value}),c.success("批量删除成功"),C.value=[],p()}catch(o){console.error("批量删除失败:",o),c.error("批量删除失败")}})},Y=()=>{Object.assign(d,{db_config_id:null,table_name:"",table_type:"",min_row_count:null,max_row_count:null,order_by:"created_at",order_direction:"desc"}),s.skip=0,p()},Z=o=>{s.limit=o,s.skip=0,p()},ee=o=>{s.skip=(o-1)*s.limit,p()},le=o=>({TABLE:"primary",VIEW:"success",LOG:"warning",FACT:"info"})[o]||"primary",k=o=>o?new Date(o).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-";return re(()=>{P(),p()}),(o,l)=>{const m=i("el-icon"),f=i("el-button"),h=i("el-option"),E=i("el-select"),V=i("el-form-item"),I=i("el-input"),U=i("el-input-number"),S=i("el-form"),_=i("el-table-column"),te=i("el-tag"),ae=i("el-table"),oe=i("el-pagination"),N=i("el-dialog"),y=i("el-descriptions-item"),ne=i("el-descriptions"),ie=_e("loading");return v(),T("div",he,[b("div",Ve,[l[11]||(l[11]=b("h2",null,"表元数据管理",-1)),b("div",xe,[e(f,{type:"primary",onClick:J},{default:t(()=>[e(m,null,{default:t(()=>[e(A(pe))]),_:1}),l[9]||(l[9]=n(" 扫描表元数据 ",-1))]),_:1}),e(f,{type:"danger",disabled:C.value.length===0,onClick:X},{default:t(()=>[e(m,null,{default:t(()=>[e(A(me))]),_:1}),l[10]||(l[10]=n(" 批量删除 ",-1))]),_:1},8,["disabled"])])]),b("div",Ce,[e(S,{model:d,inline:!0},{default:t(()=>[e(V,{label:"数据库配置"},{default:t(()=>[e(E,{modelValue:d.db_config_id,"onUpdate:modelValue":l[0]||(l[0]=a=>d.db_config_id=a),placeholder:"选择数据库配置",clearable:"",style:{width:"200px"}},{default:t(()=>[(v(!0),T(O,null,j(M.value,a=>(v(),z(h,{key:a.id,label:`${a.database_name} (${a.type})`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(V,{label:"表名"},{default:t(()=>[e(I,{modelValue:d.table_name,"onUpdate:modelValue":l[1]||(l[1]=a=>d.table_name=a),placeholder:"搜索表名",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),e(V,{label:"表类型"},{default:t(()=>[e(E,{modelValue:d.table_type,"onUpdate:modelValue":l[2]||(l[2]=a=>d.table_type=a),placeholder:"选择表类型",clearable:"",style:{width:"150px"}},{default:t(()=>[e(h,{label:"TABLE",value:"TABLE"}),e(h,{label:"VIEW",value:"VIEW"}),e(h,{label:"LOG",value:"LOG"}),e(h,{label:"FACT",value:"FACT"})]),_:1},8,["modelValue"])]),_:1}),e(V,{label:"行数范围"},{default:t(()=>[e(U,{modelValue:d.min_row_count,"onUpdate:modelValue":l[3]||(l[3]=a=>d.min_row_count=a),placeholder:"最小行数",min:0,style:{width:"120px"}},null,8,["modelValue"]),l[12]||(l[12]=b("span",{style:{margin:"0 10px"}},"-",-1)),e(U,{modelValue:d.max_row_count,"onUpdate:modelValue":l[4]||(l[4]=a=>d.max_row_count=a),placeholder:"最大行数",min:d.min_row_count,style:{width:"120px"}},null,8,["modelValue","min"])]),_:1}),e(V,null,{default:t(()=>[e(f,{type:"primary",onClick:p},{default:t(()=>[e(m,null,{default:t(()=>[e(A(fe))]),_:1}),l[13]||(l[13]=n(" 搜索 ",-1))]),_:1}),e(f,{onClick:Y},{default:t(()=>[...l[14]||(l[14]=[n(" 重置 ",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),b("div",Te,[ue((v(),z(ae,{data:F.value,onSelectionChange:H,style:{width:"100%"}},{default:t(()=>[e(_,{type:"selection",width:"55"}),e(_,{prop:"id",label:"ID",width:"80"}),e(_,{prop:"table_name",label:"表名","min-width":"150","show-overflow-tooltip":""}),e(_,{prop:"table_description",label:"表描述","min-width":"200","show-overflow-tooltip":""}),e(_,{prop:"table_row_count",label:"行数",width:"100",sortable:""}),e(_,{prop:"table_type",label:"类型",width:"100"},{default:t(({row:a})=>[e(te,{type:le(a.table_type),size:"small"},{default:t(()=>[n(u(a.table_type||"TABLE"),1)]),_:2},1032,["type"])]),_:1}),e(_,{prop:"created_at",label:"创建时间",width:"180"},{default:t(({row:a})=>[n(u(k(a.created_at)),1)]),_:1}),e(_,{prop:"updated_at",label:"更新时间",width:"180"},{default:t(({row:a})=>[n(u(k(a.updated_at)),1)]),_:1}),e(_,{label:"操作",width:"200",fixed:"right"},{default:t(({row:a})=>[e(f,{type:"primary",size:"small",onClick:de=>Q(a)},{default:t(()=>[...l[15]||(l[15]=[n(" 详情 ",-1)])]),_:1},8,["onClick"]),e(f,{type:"danger",size:"small",onClick:de=>R(a)},{default:t(()=>[...l[16]||(l[16]=[n(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ie,D.value]]),b("div",ke,[e(oe,{"current-page":q.value,"page-size":s.limit,"page-sizes":[20,50,100,200],total:s.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Z,onCurrentChange:ee},null,8,["current-page","page-size","total"])])]),e(N,{modelValue:x.value,"onUpdate:modelValue":l[7]||(l[7]=a=>x.value=a),title:"扫描表元数据",width:"400px"},{footer:t(()=>[e(f,{onClick:l[6]||(l[6]=a=>x.value=!1)},{default:t(()=>[...l[17]||(l[17]=[n("取消",-1)])]),_:1}),e(f,{type:"primary",onClick:K,loading:B.value},{default:t(()=>[...l[18]||(l[18]=[n(" 开始扫描 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(S,{model:w,"label-width":"120px"},{default:t(()=>[e(V,{label:"数据库配置",required:""},{default:t(()=>[e(E,{modelValue:w.db_config_id,"onUpdate:modelValue":l[5]||(l[5]=a=>w.db_config_id=a),placeholder:"选择数据库配置",style:{width:"100%"}},{default:t(()=>[(v(!0),T(O,null,j(M.value,a=>(v(),z(h,{key:a.id,label:`${a.database_name} (${a.type})`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(N,{modelValue:L.value,"onUpdate:modelValue":l[8]||(l[8]=a=>L.value=a),title:"表元数据详情",width:"800px"},{default:t(()=>[r.value?(v(),T("div",De,[e(ne,{column:2,border:""},{default:t(()=>[e(y,{label:"ID"},{default:t(()=>[n(u(r.value.id),1)]),_:1}),e(y,{label:"数据库配置ID"},{default:t(()=>[n(u(r.value.db_config_id),1)]),_:1}),e(y,{label:"表名"},{default:t(()=>[n(u(r.value.table_name),1)]),_:1}),e(y,{label:"表类型"},{default:t(()=>[n(u(r.value.table_type||"TABLE"),1)]),_:1}),e(y,{label:"行数"},{default:t(()=>[n(u(r.value.table_row_count||"-"),1)]),_:1}),e(y,{label:"创建时间"},{default:t(()=>[n(u(k(r.value.created_at)),1)]),_:1}),e(y,{label:"更新时间"},{default:t(()=>[n(u(k(r.value.updated_at)),1)]),_:1})]),_:1}),r.value.table_ddl?(v(),T("div",Be,[l[19]||(l[19]=b("h4",{style:{"margin-top":"20px","margin-bottom":"10px"}},"表结构 DDL",-1)),e(I,{"model-value":r.value.table_ddl,type:"textarea",rows:10,readonly:""},null,8,["model-value"])])):G("",!0)])):G("",!0)]),_:1},8,["modelValue"])])}}},Ae=se(Le,[["__scopeId","data-v-35433874"]]);export{Ae as default};
