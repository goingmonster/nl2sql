import{_ as Re,f as Qe,c as y,a as p,b as a,w as n,J as Fe,g as je,h as L,t as c,E as d,m as j,r as m,j as b,k as Be,o as u,u as ie,s as Te,F as O,x as J,n as i,p as Me,i as re,v as de}from"./index-CPm_9BR3.js";import{r as S}from"./index-DefhRm7t.js";import{g as We}from"./nlsqlTaskConfig-vN1Wt6V1.js";import{g as He}from"./llmConfig-D4kKmIJP.js";function Ke(_){return S({url:"/qa-embedding/",method:"get",params:_})}function ue(_){return S({url:`/qa-embedding/${_}`,method:"get"})}function Pe(_){return S({url:"/qa-embedding/",method:"post",data:_})}function Ge(_,D){return S({url:`/qa-embedding/${_}`,method:"put",data:D})}function Xe(_){return S({url:`/qa-embedding/${_}`,method:"delete"})}function Ye(_){return S({url:"/qa-embedding/batch-delete",method:"post",data:{ids:_}})}function Ze(_){return S({url:"/qa-embedding/import",method:"post",data:_})}function et(_){return S({url:"/qa-embedding/generate-where-conditions",method:"post",data:_,timeout:18e4})}function tt(_){return S({url:"/qa-embedding/export",method:"post",data:{ids:_}})}const lt={class:"table-metadata-view"},at={class:"card search-card"},nt={class:"search-section"},ot={class:"card table-card"},st={class:"table-container"},it={key:1,class:"empty-text"},rt={class:"compact-pagination"},dt={class:"pagination-content"},ut={class:"record-count"},ct={key:0,class:"view-detail-wrap"},pt={class:"detail-section"},_t={key:0,class:"tag-list"},ft={key:1,class:"empty-text"},mt={class:"detail-section"},gt={class:"code-block"},wt={class:"detail-section"},vt={key:0,class:"condition-list"},bt={class:"cond-field"},yt={class:"cond-op"},ht={class:"cond-val"},kt={key:0,class:"cond-desc"},qt={key:1,class:"empty-text"},xt={__name:"QAExample",setup(_){const D=b(!1),W=b(!1),H=b(!1),K=b(!1),P=b([]),B=b([]),Z=b([]),g=b([]),ee=b(null),$=b(!1),T=b(!1),U=b(!1),I=b(!1),R=b(!1),Q=b(null),w=b(null),h=j({table_name:"",task_id:null}),f=j({page:1,page_size:10,total:0}),o=j({id:null,nlsql_task_id:null,question:"",sql:"",where_conditions_text:"",tables_text:"",is_enabled:!0}),x=j({task_id:null,json_text:""}),N=j({llm_config_id:null}),ce={nlsql_task_id:[{required:!0,message:"请选择任务",trigger:"change"}],question:[{required:!0,message:"请输入问题",trigger:"blur"}],sql:[{required:!0,message:"请输入SQL",trigger:"blur"}]};async function pe(){try{const l=await We({page:1,page_size:100});B.value=l.items||l.data||[]}catch(l){console.error("获取任务列表失败:",l),d.error("获取任务列表失败")}}async function _e(){try{const l=await He({page:1,page_size:100,status:1});Z.value=l.data||l.items||[]}catch(l){console.error("获取LLM配置失败:",l),d.error("获取LLM配置失败")}}async function V(){try{D.value=!0;const l={page:f.page,page_size:f.page_size};h.task_id&&(l.task_id=h.task_id),h.table_name&&(l.question=h.table_name);const e=await Ke(l);P.value=e.data||e.items||[],f.total=e.pagination?.total||e.total||0,g.value=[],ee.value?.clearSelection()}catch(l){console.error("获取问答样例列表失败:",l),d.error("获取问答样例列表失败")}finally{D.value=!1}}function te(){f.page=1,V()}function fe(){h.table_name="",h.task_id=null,f.page=1,V()}function me(){f.page=1,V()}function ge(l){g.value=l}function we(l){f.page_size=l,f.page=1,V()}function ve(l){f.page=l,V()}async function le(){await V(),P.value.length===0&&f.page>1&&(f.page-=1,await V())}function be(){R.value=!1,ae(),h.task_id&&(o.nlsql_task_id=h.task_id),$.value=!0}async function ye(l){try{R.value=!0;const e=await ue(l.id),s=e.data||e;o.id=s.id,o.nlsql_task_id=s.nlsql_task_id,o.question=s.question||"",o.sql=s.sql||"",o.where_conditions_text=s.where_conditions?JSON.stringify(s.where_conditions,null,2):"",o.tables_text=s.tables?JSON.stringify(s.tables,null,2):"",o.is_enabled=s.is_enabled!==!1,$.value=!0}catch(e){console.error("获取问答样例详情失败:",e),d.error("获取问答样例详情失败")}}async function he(l){try{const e=await ue(l.id);w.value=e.data||e,T.value=!0}catch(e){console.error("获取问答样例详情失败:",e),d.error("获取问答样例详情失败")}}async function ke(l){try{await de.confirm(`确定删除问答样例 #${l.id} 吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Xe(l.id),d.success("删除成功"),await le()}catch(e){e!=="cancel"&&(console.error("删除问答样例失败:",e),d.error(e.response?.data?.detail||"删除失败"))}}async function qe(){if(g.value.length===0){d.warning("请选择要删除的记录");return}try{await de.confirm(`确定删除选中的 ${g.value.length} 条记录吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const l=g.value.map(e=>e.id).filter(e=>Number.isFinite(e));await Ye(l),d.success("批量删除成功"),await le()}catch(l){l!=="cancel"&&(console.error("批量删除失败:",l),d.error(l.response?.data?.detail||"批量删除失败"))}}async function xe(){if(Q.value)try{await Q.value.validate(),W.value=!0;const l=$e(o.where_conditions_text),e=Ne(o.tables_text);R.value?(await Ge(o.id,{question:o.question.trim(),sql:o.sql.trim(),where_conditions:l,tables:e,is_enabled:o.is_enabled}),d.success("更新成功")):(await Pe({question:o.question.trim(),nlsql_task_id:Number(o.nlsql_task_id),sql:o.sql.trim(),where_conditions:l,tables:e,is_enabled:o.is_enabled}),d.success("创建成功")),$.value=!1,await V()}catch(l){console.error("保存问答样例失败:",l),d.error(l.response?.data?.detail||l.message||"保存失败")}finally{W.value=!1}}function Ve(){ne(),h.task_id&&(x.task_id=h.task_id),U.value=!0}async function Ce(){try{if(!x.task_id){d.warning("请选择任务");return}const l=Ae(x.json_text);H.value=!0;const e=await Ze({task_id:Number(x.task_id),qa_json:l});d.success(`导入成功，新增 ${e.data?.created_count??e.created_count??0} 条`),U.value=!1,f.page=1,await V()}catch(l){console.error("导入问答对失败:",l),d.error(l.response?.data?.detail||l.message||"导入失败")}finally{H.value=!1}}async function Ee(){if(g.value.length===0){d.warning("请先选择要分析的问答对");return}oe(),await _e(),I.value=!0}async function Se(){try{if(!N.llm_config_id){d.warning("请选择LLM配置");return}K.value=!0;const l={qa_embedding_ids:g.value.map(r=>r.id).filter(r=>Number.isFinite(r)),llm_config_id:Number(N.llm_config_id)},e=await et(l),s=e.data||e;d.success(`分析完成：成功 ${s.success_count||0} 条，失败 ${s.failed_count||0} 条`),Array.isArray(s.failed_items)&&s.failed_items.length>0&&console.error("AI分析失败项:",s.failed_items),I.value=!1,await V()}catch(l){console.error("AI分析失败:",l),d.error(l.response?.data?.detail||l.message||"AI分析失败")}finally{K.value=!1}}async function Le(){if(g.value.length===0){d.warning("请选择要导出的记录");return}try{const l=g.value.map(k=>k.id).filter(k=>Number.isFinite(k)),e=await tt(l),s=e.data||e,r=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),q=URL.createObjectURL(r),C=document.createElement("a");C.href=q;const v=new Date().toISOString().slice(0,10);C.download=`qa_export_${v}.json`,document.body.appendChild(C),C.click(),document.body.removeChild(C),URL.revokeObjectURL(q),d.success(`成功导出 ${s.length} 条问答对`)}catch(l){console.error("导出失败:",l),d.error(l.response?.data?.detail||l.message||"导出失败")}}function $e(l){const e=(l||"").trim();if(!e)return null;try{const s=JSON.parse(e);if(!Array.isArray(s))throw new Error("WHERE条件必须是JSON数组");return s}catch(s){throw new Error(`WHERE条件JSON格式不正确: ${s.message}`)}}function Ne(l){const e=(l||"").trim();if(!e)return null;try{const s=JSON.parse(e);if(!Array.isArray(s))throw new Error("使用的表必须是JSON数组");return s}catch(s){throw new Error(`使用的表JSON格式不正确: ${s.message}`)}}function Ae(l){const e=(l||"").trim();if(!e)throw new Error("请粘贴要导入的JSON内容");let s;try{s=JSON.parse(e)}catch(r){throw new Error(`JSON解析失败: ${r.message}`)}if(!Array.isArray(s)||s.length===0)throw new Error("导入内容必须是非空JSON数组");return s.forEach((r,q)=>{if(!r||typeof r!="object")throw new Error(`第 ${q+1} 项必须是对象`);if(!r.question||typeof r.question!="string")throw new Error(`第 ${q+1} 项缺少 question`);if(!r.sql||typeof r.sql!="string")throw new Error(`第 ${q+1} 项缺少 sql`);if(r.where_conditions!==void 0&&r.where_conditions!==null&&!Array.isArray(r.where_conditions))throw new Error(`第 ${q+1} 项 where_conditions 必须是数组`)}),s}function G(l){return l?new Date(l).toLocaleString("zh-CN"):"-"}function ze(l){return l==null?"null":typeof l=="object"?JSON.stringify(l):String(l)}function ae(){o.id=null,o.nlsql_task_id=null,o.question="",o.sql="",o.where_conditions_text="",o.tables_text="",o.is_enabled=!0,Q.value&&Q.value.resetFields()}function ne(){x.task_id=null,x.json_text=""}function oe(){N.llm_config_id=null}return Qe(async()=>{await pe(),await V()}),(l,e)=>{const s=m("el-icon"),r=m("el-input"),q=m("el-option"),C=m("el-select"),v=m("el-button"),k=m("el-table-column"),F=m("el-tag"),X=m("el-link"),se=m("el-divider"),Oe=m("el-table"),Je=m("el-pagination"),E=m("el-form-item"),De=m("el-switch"),Y=m("el-form"),M=m("el-dialog"),A=m("el-descriptions-item"),Ue=m("el-descriptions"),Ie=Be("loading");return u(),y("div",lt,[p("div",at,[e[25]||(e[25]=p("h2",{class:"card-title"},"问答样例管理",-1)),e[26]||(e[26]=p("p",{class:"page-desc"},"支持导入问答对、增删改查、批量删除与 AI 分析 where 条件",-1)),p("div",nt,[a(r,{modelValue:h.table_name,"onUpdate:modelValue":e[0]||(e[0]=t=>h.table_name=t),placeholder:"按表名/关键词筛选",clearable:"",class:"search-input",onKeyup:Fe(te,["enter"])},{prefix:n(()=>[a(s,null,{default:n(()=>[a(ie(Te))]),_:1})]),_:1},8,["modelValue"]),a(C,{modelValue:h.task_id,"onUpdate:modelValue":e[1]||(e[1]=t=>h.task_id=t),placeholder:"选择任务",clearable:"",class:"task-select",onChange:me},{default:n(()=>[(u(!0),y(O,null,J(B.value,t=>(u(),L(q,{key:t.id,label:`${t.id} - ${t.description||"无描述"}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(v,{type:"primary",onClick:te},{default:n(()=>[...e[21]||(e[21]=[i("查询",-1)])]),_:1}),a(v,{onClick:fe},{default:n(()=>[...e[22]||(e[22]=[i("重置",-1)])]),_:1}),a(v,{type:"primary",onClick:be},{default:n(()=>[a(s,null,{default:n(()=>[a(ie(Me))]),_:1}),e[23]||(e[23]=i(" 新增 ",-1))]),_:1}),a(v,{onClick:Ve},{default:n(()=>[...e[24]||(e[24]=[i("导入问答对",-1)])]),_:1}),a(v,{type:"success",disabled:g.value.length===0,onClick:Ee},{default:n(()=>[i(" AI分析问答对 ("+c(g.value.length)+") ",1)]),_:1},8,["disabled"]),a(v,{type:"danger",disabled:g.value.length===0,onClick:qe},{default:n(()=>[i(" 批量删除 ("+c(g.value.length)+") ",1)]),_:1},8,["disabled"]),a(v,{type:"warning",disabled:g.value.length===0,onClick:Le},{default:n(()=>[i(" 导出 ("+c(g.value.length)+") ",1)]),_:1},8,["disabled"])])]),p("div",ot,[p("div",st,[je((u(),L(Oe,{ref_key:"tableRef",ref:ee,data:P.value,style:{width:"100%"},onSelectionChange:ge},{default:n(()=>[a(k,{type:"selection",width:"55"}),a(k,{prop:"id",label:"ID",width:"90"}),a(k,{prop:"nlsql_task_id",label:"任务ID",width:"100"}),a(k,{prop:"question",label:"问题","min-width":"260","show-overflow-tooltip":""}),a(k,{prop:"sql",label:"SQL","min-width":"240","show-overflow-tooltip":""}),a(k,{label:"使用的表",width:"120"},{default:n(t=>[t.row.tables&&t.row.tables.length>0?(u(),L(F,{key:0,type:"success",size:"small"},{default:n(()=>[i(c(t.row.tables.length)+" 表 ",1)]),_:2},1024)):(u(),y("span",it,"-"))]),_:1}),a(k,{label:"WHERE 条件",width:"120"},{default:n(t=>[i(c(Array.isArray(t.row.where_conditions)?t.row.where_conditions.length:0)+" 条 ",1)]),_:1}),a(k,{label:"状态",width:"90"},{default:n(t=>[a(F,{type:t.row.is_enabled?"success":"info"},{default:n(()=>[i(c(t.row.is_enabled?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(k,{prop:"created_at",label:"创建时间",width:"180"},{default:n(t=>[i(c(G(t.row.created_at)),1)]),_:1}),a(k,{label:"操作",width:"190",fixed:"right"},{default:n(t=>[a(X,{type:"primary",onClick:z=>he(t.row)},{default:n(()=>[...e[27]||(e[27]=[i("查看",-1)])]),_:1},8,["onClick"]),a(se,{direction:"vertical"}),a(X,{type:"primary",onClick:z=>ye(t.row)},{default:n(()=>[...e[28]||(e[28]=[i("编辑",-1)])]),_:1},8,["onClick"]),a(se,{direction:"vertical"}),a(X,{type:"danger",onClick:z=>ke(t.row)},{default:n(()=>[...e[29]||(e[29]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ie,D.value]])])]),p("div",rt,[p("div",dt,[p("span",ut,"共 "+c(f.total)+" 条",1),a(Je,{"current-page":f.page,"onUpdate:currentPage":e[2]||(e[2]=t=>f.page=t),"page-size":f.page_size,"onUpdate:pageSize":e[3]||(e[3]=t=>f.page_size=t),total:f.total,"page-sizes":[10,20,50,100],size:"small",layout:"prev, pager, next, sizes",background:!1,onSizeChange:we,onCurrentChange:ve},null,8,["current-page","page-size","total"])])]),a(M,{modelValue:$.value,"onUpdate:modelValue":e[11]||(e[11]=t=>$.value=t),title:R.value?"编辑问答样例":"新增问答样例",width:"980px",onClose:ae},{footer:n(()=>[a(v,{onClick:e[10]||(e[10]=t=>$.value=!1)},{default:n(()=>[...e[30]||(e[30]=[i("取消",-1)])]),_:1}),a(v,{type:"primary",loading:W.value,onClick:xe},{default:n(()=>[...e[31]||(e[31]=[i("保存",-1)])]),_:1},8,["loading"])]),default:n(()=>[a(Y,{ref_key:"formRef",ref:Q,model:o,rules:ce,"label-width":"120px"},{default:n(()=>[a(E,{label:"任务ID",prop:"nlsql_task_id"},{default:n(()=>[a(C,{modelValue:o.nlsql_task_id,"onUpdate:modelValue":e[4]||(e[4]=t=>o.nlsql_task_id=t),placeholder:"请选择任务",style:{width:"100%"},disabled:R.value},{default:n(()=>[(u(!0),y(O,null,J(B.value,t=>(u(),L(q,{key:t.id,label:`${t.id} - ${t.description||"无描述"}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a(E,{label:"问题",prop:"question"},{default:n(()=>[a(r,{modelValue:o.question,"onUpdate:modelValue":e[5]||(e[5]=t=>o.question=t),type:"textarea",rows:3,placeholder:"请输入问题"},null,8,["modelValue"])]),_:1}),a(E,{label:"SQL",prop:"sql"},{default:n(()=>[a(r,{modelValue:o.sql,"onUpdate:modelValue":e[6]||(e[6]=t=>o.sql=t),type:"textarea",rows:6,placeholder:"请输入 SQL"},null,8,["modelValue"])]),_:1}),a(E,{label:"WHERE条件(JSON)"},{default:n(()=>[a(r,{modelValue:o.where_conditions_text,"onUpdate:modelValue":e[7]||(e[7]=t=>o.where_conditions_text=t),type:"textarea",rows:6,placeholder:'可输入JSON数组，如 [{"field":"day_key","operator":"eq","value":"2025-12-06"}]'},null,8,["modelValue"])]),_:1}),a(E,{label:"使用的表"},{default:n(()=>[a(r,{modelValue:o.tables_text,"onUpdate:modelValue":e[8]||(e[8]=t=>o.tables_text=t),type:"textarea",rows:3,placeholder:'可输入JSON数组，如 ["orders", "users"]'},null,8,["modelValue"])]),_:1}),a(E,{label:"是否启用"},{default:n(()=>[a(De,{modelValue:o.is_enabled,"onUpdate:modelValue":e[9]||(e[9]=t=>o.is_enabled=t),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(M,{modelValue:T.value,"onUpdate:modelValue":e[13]||(e[13]=t=>T.value=t),title:"问答样例详情",width:"980px"},{footer:n(()=>[a(v,{onClick:e[12]||(e[12]=t=>T.value=!1)},{default:n(()=>[...e[35]||(e[35]=[i("关闭",-1)])]),_:1})]),default:n(()=>[w.value?(u(),y("div",ct,[a(Ue,{column:2,border:""},{default:n(()=>[a(A,{label:"ID"},{default:n(()=>[i(c(w.value.id),1)]),_:1}),a(A,{label:"任务ID"},{default:n(()=>[i(c(w.value.nlsql_task_id),1)]),_:1}),a(A,{label:"状态"},{default:n(()=>[a(F,{type:w.value.is_enabled?"success":"info"},{default:n(()=>[i(c(w.value.is_enabled?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),a(A,{label:"创建时间"},{default:n(()=>[i(c(G(w.value.created_at)),1)]),_:1}),a(A,{label:"更新时间"},{default:n(()=>[i(c(G(w.value.updated_at)),1)]),_:1}),a(A,{label:"问题",span:2},{default:n(()=>[i(c(w.value.question),1)]),_:1})]),_:1}),p("div",pt,[e[32]||(e[32]=p("h4",null,"使用的表",-1)),Array.isArray(w.value.tables)&&w.value.tables.length>0?(u(),y("div",_t,[(u(!0),y(O,null,J(w.value.tables,(t,z)=>(u(),L(F,{key:`table-${z}`,type:"success",size:"small",class:"table-tag"},{default:n(()=>[i(c(t),1)]),_:2},1024))),128))])):(u(),y("div",ft,"暂无表信息"))]),p("div",mt,[e[33]||(e[33]=p("h4",null,"SQL",-1)),p("pre",gt,c(w.value.sql||"-"),1)]),p("div",wt,[e[34]||(e[34]=p("h4",null,"WHERE 条件",-1)),Array.isArray(w.value.where_conditions)&&w.value.where_conditions.length>0?(u(),y("div",vt,[(u(!0),y(O,null,J(w.value.where_conditions,(t,z)=>(u(),y("div",{key:`cond-${z}`,class:"condition-item"},[p("span",bt,c(t.field),1),p("span",yt,c(t.operator),1),p("span",ht,c(ze(t.value)),1),t.description?(u(),y("span",kt,c(t.description),1)):re("",!0)]))),128))])):(u(),y("div",qt,"暂无 WHERE 条件"))])])):re("",!0)]),_:1},8,["modelValue"]),a(M,{modelValue:U.value,"onUpdate:modelValue":e[17]||(e[17]=t=>U.value=t),title:"导入问答对",width:"920px",onClose:ne},{footer:n(()=>[a(v,{onClick:e[16]||(e[16]=t=>U.value=!1)},{default:n(()=>[...e[37]||(e[37]=[i("取消",-1)])]),_:1}),a(v,{type:"primary",loading:H.value,onClick:Ce},{default:n(()=>[...e[38]||(e[38]=[i("导入",-1)])]),_:1},8,["loading"])]),default:n(()=>[a(Y,{model:x,"label-width":"120px"},{default:n(()=>[a(E,{label:"任务ID",required:""},{default:n(()=>[a(C,{modelValue:x.task_id,"onUpdate:modelValue":e[14]||(e[14]=t=>x.task_id=t),placeholder:"请选择任务",style:{width:"100%"}},{default:n(()=>[(u(!0),y(O,null,J(B.value,t=>(u(),L(q,{key:t.id,label:`${t.id} - ${t.description||"无描述"}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(E,{label:"JSON内容",required:""},{default:n(()=>[a(r,{modelValue:x.json_text,"onUpdate:modelValue":e[15]||(e[15]=t=>x.json_text=t),type:"textarea",rows:14,placeholder:'请粘贴JSON数组，例如 [{"question":"...","sql":"...","where_conditions":[...]}]'},null,8,["modelValue"]),e[36]||(e[36]=p("div",{class:"help-text"},"根节点必须是数组，每项至少包含 question 和 sql 字段。",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(M,{modelValue:I.value,"onUpdate:modelValue":e[20]||(e[20]=t=>I.value=t),title:"AI分析问答对",width:"600px",onClose:oe},{footer:n(()=>[a(v,{onClick:e[19]||(e[19]=t=>I.value=!1)},{default:n(()=>[...e[39]||(e[39]=[i("取消",-1)])]),_:1}),a(v,{type:"primary",loading:K.value,onClick:Se},{default:n(()=>[...e[40]||(e[40]=[i("开始分析",-1)])]),_:1},8,["loading"])]),default:n(()=>[a(Y,{model:N,"label-width":"140px"},{default:n(()=>[a(E,{label:"已选问答对"},{default:n(()=>[a(F,{type:"info"},{default:n(()=>[i(c(g.value.length)+" 条",1)]),_:1})]),_:1}),a(E,{label:"LLM配置",required:""},{default:n(()=>[a(C,{modelValue:N.llm_config_id,"onUpdate:modelValue":e[18]||(e[18]=t=>N.llm_config_id=t),placeholder:"请选择LLM配置",style:{width:"100%"}},{default:n(()=>[(u(!0),y(O,null,J(Z.value,t=>(u(),L(q,{key:t.id,label:`${t.id} - ${t.provider||"unknown"} - ${t.model_name||"-"}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Lt=Re(xt,[["__scopeId","data-v-64802e48"]]);export{Lt as default};
