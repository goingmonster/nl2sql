import{g as me}from"./nlsqlTaskConfig-vN1Wt6V1.js";import{r as V}from"./index-DefhRm7t.js";import{_ as fe,f as ge,c as b,a as d,h as T,w as n,i as k,b as a,g as ve,t as u,E as h,j as f,r as i,k as be,y as he,m as ye,o as p,n as r,F as J,x as j,v as we}from"./index-CPm_9BR3.js";const Te=g=>V({url:`/metadata/task/${g}`,method:"get"}),ke=(g,y)=>V({url:`/metadata/table/${g}/description`,method:"put",data:{description:y}}),xe=(g,y)=>V({url:`/metadata/field/${g}/description`,method:"put",data:{description:y}}),Se=g=>V({url:"/metadata/table/batch",method:"delete",data:g}),De={class:"metadata-detail-container"},ze={class:"metadata-detail-header"},Ce={class:"header-left"},Ve={class:"metadata-content"},Me={class:"card-header"},$e={class:"card"},Ne={class:"table-container"},Be={class:"compact-pagination"},Fe={class:"pagination-content"},Le={class:"record-count"},Pe={key:0,class:"table-detail-content"},Ie={class:"statistic-display"},Ue={style:{display:"flex",gap:"10px","align-items":"flex-start"}},Ae={style:{"margin-top":"10px",color:"#909399"}},Ee={key:0},Oe={key:0},qe={key:1},Je={style:{display:"flex",gap:"8px","align-items":"center"}},je={class:"dialog-footer"},Ge={__name:"MetadataDetail",setup(g){const y=f(!1),M=f(null),A=f([]),o=f(null),s=f(null),D=f(!1),$=f(!1),N=f({}),v=f([]),B=f(!1),_=ye({currentPage:1,pageSize:5,total:0}),G=async()=>{try{const e=await me({page:1,page_size:100});A.value=e.items||[]}catch(e){console.error("获取任务列表失败:",e),h.error("获取任务列表失败")}},E=async e=>{if(!e){o.value=null;return}y.value=!0;try{const t=await Te(e);t&&t.data?o.value=t.data:o.value=t,_.currentPage=1,o.value&&o.value.tables&&(_.total=o.value.tables.length)}catch(t){console.error("获取元数据失败:",t),h.error(t.response?.data?.detail||"获取元数据失败"),o.value=null}finally{y.value=!1}},H=he(()=>{if(!o.value||!o.value.tables)return[];const e=(_.currentPage-1)*_.pageSize,t=e+_.pageSize;return o.value.tables.slice(e,t)}),K=e=>{_.currentPage=e},W=e=>{_.pageSize=e,_.currentPage=1},Q=e=>{s.value=JSON.parse(JSON.stringify(e)),D.value=!0},R=async()=>{if(s.value){$.value=!0;try{await ke(s.value.table_id,s.value.table_description),h.success("表描述保存成功");const e=o.value.tables.find(t=>t.table_id===s.value.table_id);e&&(e.table_description=s.value.table_description)}catch{h.error("表描述保存失败")}finally{$.value=!1}}},X=async e=>{N.value[e.field_id]=!0;try{await xe(e.field_id,e.field_description),h.success(`字段 "${e.field_name}" 描述保存成功`);const t=o.value.tables.find(m=>m.table_id===s.value.table_id);if(t){const m=t.field_metadata.find(x=>x.field_id===e.field_id);m&&(m.field_description=e.field_description)}}catch{h.error(`字段 "${e.field_name}" 描述保存失败`)}finally{N.value[e.field_id]=!1}},Y=e=>{v.value=e},Z=()=>{if(v.value.length===0)return;const e=v.value.map(t=>`${t.schema_name}.${t.table_name}`).join(", ");we.confirm(`确定要删除以下 ${v.value.length} 个表的元数据吗？
${e}

此操作将级联删除相关的样例数据和字段元数据，且不可恢复！`,"批量删除警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,customClass:"batch-delete-dialog"}).then(async()=>{B.value=!0;try{const t=v.value.map(x=>x.table_id),m=await Se(t);h.success(m.message||"批量删除成功"),v.value=[],E(M.value)}catch(t){console.error("批量删除失败:",t),h.error(t.response?.data?.detail||"批量删除失败")}finally{B.value=!1}})},z=e=>{if(!e.sample_data)return null;try{return JSON.parse(e.sample_data)}catch{return null}},F=e=>{if(!e.sample_data||e.sample_data==="[]")return[];try{const t=JSON.parse(e.sample_data);return Array.isArray(t)?t:[]}catch{return[]}},ee=e=>e?e.includes("String")||e.includes("string")?"primary":e.includes("Int")||e.includes("UInt")||e.includes("int")?"success":e.includes("Float")||e.includes("Decimal")?"warning":e.includes("DateTime")||e.includes("Date")||e.includes("Time")?"danger":e.includes("Nullable")?"info":e.includes("Array")?"warning":"info":"info",te=e=>!e&&e!==0?0:e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString(),ae=e=>({1:"info",2:"warning",3:"primary",4:"success",5:"success"})[e]||"info",le=e=>({1:"初始化",2:"提取元数据",3:"生成表提示词",4:"生成字段提示词",5:"完成"})[e]||"未知状态",O=e=>({TABLE:"primary",VIEW:"success",LOG:"warning",FACT:"info",mergetree:"primary",MergeTree:"primary",distributed:"warning"})[e]||"primary",ne=e=>e?new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-";return ge(()=>{G()}),(e,t)=>{const m=i("el-button"),x=i("el-option"),se=i("el-select"),oe=i("el-alert"),S=i("el-tag"),L=i("el-descriptions-item"),ie=i("el-descriptions"),re=i("el-card"),c=i("el-table-column"),de=i("el-link"),P=i("el-table"),ue=i("el-pagination"),q=i("el-statistic"),I=i("el-col"),ce=i("el-row"),U=i("el-input"),C=i("el-form-item"),pe=i("el-dialog"),_e=be("loading");return p(),b("div",De,[d("div",ze,[d("div",Ce,[t[6]||(t[6]=d("h2",null,"详细元数据管理",-1)),v.value.length>0?(p(),T(m,{key:0,type:"danger",onClick:Z,loading:B.value,size:"small"},{default:n(()=>[r(" 批量删除 ("+u(v.value.length)+") ",1)]),_:1},8,["loading"])):k("",!0)]),a(se,{modelValue:M.value,"onUpdate:modelValue":t[0]||(t[0]=l=>M.value=l),placeholder:"请选择任务ID",style:{width:"300px"},onChange:E,clearable:""},{default:n(()=>[(p(!0),b(J,null,j(A.value,l=>(p(),T(x,{key:l.id,label:`${l.id} - ${l.description||"无描述"}`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),ve((p(),b("div",Ve,[o.value&&(!o.value.tables||o.value.tables.length===0)?(p(),T(oe,{key:0,title:"该任务没有元数据，请先执行元数据扫描",type:"warning"})):k("",!0),o.value&&o.value.tables?(p(),T(re,{key:1,class:"info-card"},{header:n(()=>[d("div",Me,[t[7]||(t[7]=d("span",null,"任务基本信息",-1)),a(S,{type:ae(o.value.status)},{default:n(()=>[r(u(le(o.value.status)),1)]),_:1},8,["type"])])]),default:n(()=>[a(ie,{column:3,border:""},{default:n(()=>[a(L,{label:"任务ID"},{default:n(()=>[r(u(o.value.task_id),1)]),_:1}),a(L,{label:"数据库配置ID"},{default:n(()=>[r(u(o.value.db_config_id),1)]),_:1}),a(L,{label:"总表数"},{default:n(()=>[r(u(o.value.total_tables),1)]),_:1})]),_:1})]),_:1})):k("",!0),d("div",$e,[d("div",Ne,[a(P,{data:H.value,style:{width:"100%"},onSelectionChange:Y},{default:n(()=>[a(c,{type:"selection",width:"55"}),a(c,{label:"表ID",width:"80",prop:"table_id","show-overflow-tooltip":""}),a(c,{label:"Schema",width:"120",prop:"schema_name","show-overflow-tooltip":""}),a(c,{label:"表名称","min-width":"200","show-overflow-tooltip":""},{default:n(({row:l})=>[a(de,{type:"primary",onClick:w=>Q(l)},{default:n(()=>[r(u(l.table_name),1)]),_:2},1032,["onClick"])]),_:1}),a(c,{label:"表类型",width:"100"},{default:n(({row:l})=>[a(S,{type:O(l.table_type)},{default:n(()=>[r(u(l.table_type||"TABLE"),1)]),_:2},1032,["type"])]),_:1}),a(c,{label:"数据行数",width:"120"},{default:n(({row:l})=>[a(S,{type:"success",size:"small"},{default:n(()=>[r(u(Number(l.table_row_count).toLocaleString()),1)]),_:2},1024)]),_:1}),a(c,{prop:"table_description",label:"描述","min-width":"200","show-overflow-tooltip":""}),a(c,{label:"创建时间",width:"180"},{default:n(({row:l})=>[r(u(ne(l.created_at)),1)]),_:1})]),_:1},8,["data"])])]),d("div",Be,[d("div",Fe,[d("span",Le,u(_.total),1),a(ue,{"current-page":_.currentPage,"onUpdate:currentPage":t[1]||(t[1]=l=>_.currentPage=l),"page-size":_.pageSize,"onUpdate:pageSize":t[2]||(t[2]=l=>_.pageSize=l),"page-sizes":[5,10,20,50],total:_.total,size:"small",layout:"prev, pager, next, sizes",background:!1,onSizeChange:W,onCurrentChange:K},null,8,["current-page","page-size","total"])])])])),[[_e,y.value]]),a(pe,{modelValue:D.value,"onUpdate:modelValue":t[5]||(t[5]=l=>D.value=l),title:`${s.value?.schema_name}.${s.value?.table_name} - 详细信息`,width:"90%",top:"5vh","destroy-on-close":""},{footer:n(()=>[d("span",je,[a(m,{onClick:t[4]||(t[4]=l=>D.value=!1)},{default:n(()=>[...t[11]||(t[11]=[r("关闭",-1)])]),_:1})])]),default:n(()=>[s.value?(p(),b("div",Pe,[a(ce,{gutter:20,style:{"margin-bottom":"20px"}},{default:n(()=>[a(I,{span:8},{default:n(()=>[a(q,{title:"数据行数",value:Number(s.value.table_row_count)},null,8,["value"])]),_:1}),a(I,{span:8},{default:n(()=>[a(q,{title:"字段数量",value:s.value.field_metadata?.length||0},null,8,["value"])]),_:1}),a(I,{span:8},{default:n(()=>[d("div",Ie,[t[8]||(t[8]=d("div",{class:"statistic-title"},"表类型",-1)),a(S,{type:O(s.value.table_type),size:"large"},{default:n(()=>[r(u(s.value.table_type||"TABLE"),1)]),_:1},8,["type"])])]),_:1})]),_:1}),a(C,{label:"表描述",style:{"margin-bottom":"20px"}},{default:n(()=>[d("div",Ue,[a(U,{modelValue:s.value.table_description,"onUpdate:modelValue":t[3]||(t[3]=l=>s.value.table_description=l),type:"textarea",rows:2,placeholder:"请输入表描述",style:{flex:"1"}},null,8,["modelValue"]),a(m,{type:"primary",onClick:R,loading:$.value,size:"small"},{default:n(()=>[...t[9]||(t[9]=[r(" 保存表描述 ",-1)])]),_:1},8,["loading"])])]),_:1}),a(C,{label:"DDL",style:{"margin-bottom":"20px"}},{default:n(()=>[a(U,{"model-value":s.value.table_ddl,type:"textarea",rows:8,readonly:""},null,8,["model-value"])]),_:1}),z(s.value)?(p(),T(C,{key:0,label:"示例数据"},{default:n(()=>[a(P,{data:z(s.value).slice(0,10),border:"","max-height":"300",style:{width:"100%"}},{default:n(()=>[(p(!0),b(J,null,j(z(s.value)[0],(l,w)=>(p(),T(c,{key:w,prop:w,label:w,"show-overflow-tooltip":""},null,8,["prop","label"]))),128))]),_:1},8,["data"]),d("div",Ae," 显示前 10 条数据，共 "+u(z(s.value).length)+" 条 ",1)]),_:1})):k("",!0),s.value.field_metadata&&s.value.field_metadata.length>0?(p(),T(C,{key:1,label:"字段信息"},{default:n(()=>[a(P,{data:s.value.field_metadata,border:"","max-height":"400",style:{width:"100%"}},{default:n(()=>[a(c,{prop:"field_name",label:"字段名",width:"150","show-overflow-tooltip":""}),a(c,{prop:"field_type",label:"数据类型",width:"150"},{default:n(({row:l})=>[a(S,{size:"small",type:ee(l.field_type)},{default:n(()=>[r(u(l.field_type),1)]),_:2},1032,["type"])]),_:1}),a(c,{prop:"null_rate",label:"空值率",width:"100"},{default:n(({row:l})=>[r(u((l.null_rate*100).toFixed(2))+"% ",1)]),_:1}),a(c,{prop:"unique_count",label:"唯一值数",width:"120"},{default:n(({row:l})=>[r(u(te(l.unique_count)),1)]),_:1}),a(c,{label:"示例数据","min-width":"300"},{default:n(({row:l})=>[F(l)?(p(),b("span",Ee,[r(u(Array.from(F(l)).slice(0,5).join(", "))+" ",1),F(l).length>5?(p(),b("span",Oe,"...")):k("",!0)])):(p(),b("span",qe,"-"))]),_:1}),a(c,{label:"字段描述","min-width":"250"},{default:n(({row:l})=>[d("div",Je,[a(U,{modelValue:l.field_description,"onUpdate:modelValue":w=>l.field_description=w,placeholder:"请输入字段描述",size:"small",style:{flex:"1"}},null,8,["modelValue","onUpdate:modelValue"]),a(m,{type:"primary",size:"small",onClick:w=>X(l),loading:N.value[l.field_id]},{default:n(()=>[...t[10]||(t[10]=[r(" 保存 ",-1)])]),_:1},8,["onClick","loading"])])]),_:1})]),_:1},8,["data"])]),_:1})):k("",!0)])):k("",!0)]),_:1},8,["modelValue","title"])])}}},Qe=fe(Ge,[["__scopeId","data-v-aea6a159"]]);export{Qe as default};
