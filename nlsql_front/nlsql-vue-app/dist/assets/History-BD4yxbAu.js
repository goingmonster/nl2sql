import{_ as _e,f as pe,c as n,a as l,b as d,w as c,J as ye,g as Z,h as x,E as m,m as U,r as g,k as ge,j as b,N as fe,o as a,F as h,x as v,n as _,t as i,i as u,v as ke}from"./index-CPm_9BR3.js";import{g as be}from"./nlsqlTaskConfig-vN1Wt6V1.js";import{b as he,g as ve,d as we,u as xe}from"./taskChat-HVpWljCA.js";import"./index-DefhRm7t.js";const me={class:"history-page"},qe={class:"card"},Se={class:"filter-row"},Ce={class:"pagination-wrap"},ze={class:"detail-header"},Ve={class:"conversation-list"},Te={key:0,class:"empty-tip"},je={class:"q-block"},De={class:"content"},$e={class:"a-block"},Ae={class:"content"},Ee={key:0,class:"sql-panel"},Ne={class:"sql-pre"},Oe={key:1,class:"sql-panel"},Be={key:1,class:"sql-pre"},Le={key:2,class:"sql-panel"},Qe={class:"selected-table-list"},Ue={key:0,class:"ctx-row"},Re={class:"ctx-value"},Pe={key:1,class:"ctx-row"},Je={class:"ctx-value"},Me={key:3,class:"sql-panel"},Fe={class:"query-context-block"},He={key:0,class:"ctx-row"},Ke={class:"ctx-value"},We={key:1,class:"ctx-row"},Ge={class:"ctx-tag-list"},Xe={key:2,class:"ctx-row"},Ye={class:"ctx-join-list"},Ze={key:3,class:"ctx-row"},Ie={class:"sql-pre"},et={key:4,class:"sql-panel"},tt={class:"query-context-block"},st={key:0,class:"ctx-row"},lt={class:"ctx-tag-list"},at={key:1,class:"ctx-row"},ot={class:"patch-list"},nt={class:"patch-title"},rt={key:0,class:"patch-line"},it={key:1,class:"patch-line"},dt={class:"meta-row"},ct={class:"meta-text"},ut={class:"feedback-row"},_t={__name:"History",setup(pt){const I=fe(),N=b(!1),O=b(!1),B=b(!1),C=b([]),R=b([]),P=b([]),z=b([]),D=b(null),q=U({}),f=U({task_id:null,keyword:""}),p=U({page:1,page_size:20,total:0}),ee=async()=>{try{const t=await be({page:1,page_size:100});R.value=t.items||[]}catch{m.error("获取任务列表失败")}},S=async()=>{try{N.value=!0;const t={page:p.page,page_size:p.page_size};f.task_id&&(t.task_id=f.task_id),f.keyword.trim()&&(t.keyword=f.keyword.trim());const e=await he(t);P.value=e.data||[],p.total=e.pagination?.total||0}catch(t){m.error(t.response?.data?.detail||"获取会话列表失败")}finally{N.value=!1}},J=()=>{p.page=1,S()},te=async t=>{D.value=t,B.value=!0;try{O.value=!0;const e=await ve(t.id,{page:1,page_size:100});z.value=e.data||[],z.value.forEach(r=>{q[r.id]={is_right:r.is_right,feedback:r.feedback||""}})}catch(e){m.error(e.response?.data?.detail||"获取会话对话失败")}finally{O.value=!1}},se=t=>{I.push({path:"/test",query:{task_id:String(t.nlsql_task_id),session_id:String(t.id),session_title:t.session_title||""}})},le=async t=>{const e=q[t];if(e)try{C.value=[...C.value,t],await xe(t,{is_right:e.is_right,feedback:e.feedback||null});const r=z.value.find(k=>k.id===t);r&&(r.is_right=e.is_right,r.feedback=e.feedback||null),m.success("反馈已更新")}catch(r){m.error(r.response?.data?.detail||"更新反馈失败")}finally{C.value=C.value.filter(r=>r!==t)}},ae=async t=>{try{await ke.confirm(`确认删除会话 #${t.id} 吗？`,"删除确认",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"}),await we(t.id),m.success("删除成功"),S()}catch(e){e!=="cancel"&&m.error(e.response?.data?.detail||"删除失败")}},M=t=>t?new Date(t).toLocaleString("zh-CN"):"-",F=t=>{if(typeof t=="string")return t;try{return JSON.stringify(t,null,2)}catch{return String(t)}},V=t=>Object.prototype.toString.call(t)==="[object Object]",L=t=>Array.isArray(t)?t:V(t)?[t]:[],oe=t=>{const e=L(t);return e.length>0&&e.every(r=>V(r))},ne=t=>{const e=L(t),r=new Set;return e.forEach(k=>{Object.keys(k).forEach($=>r.add($))}),Array.from(r)},H=t=>Array.isArray(t)?t:[],Q=t=>{if(!t)return{};if(typeof t=="string")try{return JSON.parse(t)}catch{return{}}return V(t)?t:{}},K=t=>{const e=H(t?.selected_tables);return e.length>0?e:H(Q(t?.select_table_result).selected_tables)},re=t=>K(t).length>0,W=t=>{const e=Q(t?.select_table_result).reason;return typeof e=="string"&&e.trim()?e:""},G=t=>{const e=Q(t?.select_table_result).candidate_count;return typeof e=="number"?e:null},y=t=>{if(!t)return{};if(typeof t=="string")try{return JSON.parse(t)}catch{return{}}return V(t)?t:{}},ie=t=>{const e=y(t);return!!(e.driver_table||Array.isArray(e.allowed_tables)&&e.allowed_tables.length>0||Array.isArray(e.joins)&&e.joins.length>0||e.table_usage&&Object.keys(e.table_usage).length>0)},T=t=>{if(!t)return{};if(typeof t=="string")try{return JSON.parse(t)}catch{return{}}return V(t)?t:{}},de=t=>{const e=T(t),r=Array.isArray(e.tables)&&e.tables.length>0,k=e.column_patches&&Object.keys(e.column_patches).length>0;return!!(r||k)};return pe(async()=>{await ee(),S()}),(t,e)=>{const r=g("el-option"),k=g("el-select"),$=g("el-input"),j=g("el-button"),w=g("el-table-column"),X=g("el-table"),ce=g("el-pagination"),A=g("el-tag"),ue=g("el-dialog"),Y=ge("loading");return a(),n("div",me,[l("div",qe,[e[9]||(e[9]=l("h2",{class:"card-title"},"历史会话查看",-1)),e[10]||(e[10]=l("p",{class:"page-desc"},"按任务和关键词检索会话，查看完整问答记录",-1)),l("div",Se,[d(k,{modelValue:f.task_id,"onUpdate:modelValue":e[0]||(e[0]=s=>f.task_id=s),placeholder:"选择任务ID",clearable:"",filterable:"",class:"task-filter",onChange:S},{default:c(()=>[(a(!0),n(h,null,v(R.value,s=>(a(),x(r,{key:s.id,label:`${s.id} - ${s.description||"无描述"}`,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),d($,{modelValue:f.keyword,"onUpdate:modelValue":e[1]||(e[1]=s=>f.keyword=s),placeholder:"搜索会话标题/问题/答案",clearable:"",onKeyup:ye(J,["enter"])},null,8,["modelValue"]),d(j,{type:"primary",onClick:J},{default:c(()=>[...e[5]||(e[5]=[_("搜索",-1)])]),_:1})]),Z((a(),x(X,{data:P.value,style:{width:"100%"}},{default:c(()=>[d(w,{prop:"id",label:"会话ID",width:"90"}),d(w,{prop:"nlsql_task_id",label:"任务ID",width:"90"}),d(w,{prop:"session_title",label:"会话标题","min-width":"220","show-overflow-tooltip":""}),d(w,{prop:"conversation_count",label:"对话数",width:"90"}),d(w,{prop:"updated_at",label:"更新时间",width:"180"},{default:c(s=>[_(i(M(s.row.updated_at)),1)]),_:1}),d(w,{label:"操作",width:"210",fixed:"right"},{default:c(s=>[d(j,{link:"",type:"primary",onClick:o=>te(s.row)},{default:c(()=>[...e[6]||(e[6]=[_("查看",-1)])]),_:1},8,["onClick"]),d(j,{link:"",type:"success",onClick:o=>se(s.row)},{default:c(()=>[...e[7]||(e[7]=[_("继续",-1)])]),_:1},8,["onClick"]),d(j,{link:"",type:"danger",onClick:o=>ae(s.row)},{default:c(()=>[...e[8]||(e[8]=[_("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Y,N.value]]),l("div",Ce,[d(ce,{"current-page":p.page,"onUpdate:currentPage":e[2]||(e[2]=s=>p.page=s),"page-size":p.page_size,"onUpdate:pageSize":e[3]||(e[3]=s=>p.page_size=s),total:p.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:S,onCurrentChange:S},null,8,["current-page","page-size","total"])])]),d(ue,{modelValue:B.value,"onUpdate:modelValue":e[4]||(e[4]=s=>B.value=s),title:`会话详情 #${D.value?.id||""}`,width:"980px"},{default:c(()=>[l("div",ze,[l("div",null,"任务ID："+i(D.value?.nlsql_task_id),1),l("div",null,"会话标题："+i(D.value?.session_title||"-"),1)]),Z((a(),n("div",Ve,[z.value.length===0?(a(),n("div",Te,"暂无对话记录")):u("",!0),(a(!0),n(h,null,v(z.value,s=>(a(),n("div",{key:s.id,class:"conversation-item"},[l("div",je,[e[11]||(e[11]=l("div",{class:"label"},"Q",-1)),l("div",De,i(s.question),1)]),l("div",$e,[e[12]||(e[12]=l("div",{class:"label"},"A",-1)),l("div",Ae,i(s.answer||"-"),1)]),s.sql_generated?(a(),n("div",Ee,[e[13]||(e[13]=l("div",{class:"sql-title"},"SQL",-1)),l("pre",Ne,i(s.sql_generated),1)])):u("",!0),s.sql_data!==void 0&&s.sql_data!==null?(a(),n("div",Oe,[e[14]||(e[14]=l("div",{class:"sql-title"},"SQL Data",-1)),oe(s.sql_data)?(a(),x(X,{key:0,data:L(s.sql_data),size:"small",border:"","max-height":"280",class:"sql-table"},{default:c(()=>[(a(!0),n(h,null,v(ne(s.sql_data),o=>(a(),x(w,{key:o,prop:o,label:o,"min-width":"140","show-overflow-tooltip":""},null,8,["prop","label"]))),128))]),_:2},1032,["data"])):(a(),n("pre",Be,i(F(s.sql_data)),1))])):u("",!0),re(s)?(a(),n("div",Le,[e[17]||(e[17]=l("div",{class:"sql-title"},"Selected Tables",-1)),l("div",Qe,[(a(!0),n(h,null,v(K(s),o=>(a(),x(A,{key:`${o.table_id}-${o.table_name}`,type:"warning",effect:"plain",class:"selected-table-tag"},{default:c(()=>[_(i(o.table_name||"-")+" (ID: "+i(o.table_id??"-")+") ",1)]),_:2},1024))),128))]),W(s)?(a(),n("div",Ue,[e[15]||(e[15]=l("span",{class:"ctx-key"},"reason:",-1)),l("span",Re,i(W(s)),1)])):u("",!0),G(s)!==null?(a(),n("div",Pe,[e[16]||(e[16]=l("span",{class:"ctx-key"},"candidate_count:",-1)),l("span",Je,i(G(s)),1)])):u("",!0)])):u("",!0),ie(s.query_context)?(a(),n("div",Me,[e[22]||(e[22]=l("div",{class:"sql-title"},"Query Context",-1)),l("div",Fe,[y(s.query_context).driver_table?(a(),n("div",He,[e[18]||(e[18]=l("span",{class:"ctx-key"},"driver_table:",-1)),l("span",Ke,i(y(s.query_context).driver_table),1)])):u("",!0),y(s.query_context).allowed_tables?.length?(a(),n("div",We,[e[19]||(e[19]=l("span",{class:"ctx-key"},"allowed_tables:",-1)),l("div",Ge,[(a(!0),n(h,null,v(y(s.query_context).allowed_tables,o=>(a(),x(A,{key:`allowed-${o}`,size:"small",effect:"plain"},{default:c(()=>[_(i(o),1)]),_:2},1024))),128))])])):u("",!0),y(s.query_context).joins?.length?(a(),n("div",Xe,[e[20]||(e[20]=l("span",{class:"ctx-key"},"joins:",-1)),l("div",Ye,[(a(!0),n(h,null,v(y(s.query_context).joins,(o,E)=>(a(),n("div",{key:`join-${E}`,class:"ctx-join-item"},i(o.from||"-")+" -> "+i(o.to||"-"),1))),128))])])):u("",!0),y(s.query_context).table_usage?(a(),n("div",Ze,[e[21]||(e[21]=l("span",{class:"ctx-key"},"table_usage:",-1)),l("pre",Ie,i(F(y(s.query_context).table_usage)),1)])):u("",!0)])])):u("",!0),de(s.column_patch)?(a(),n("div",et,[e[27]||(e[27]=l("div",{class:"sql-title"},"Q Column Patch",-1)),l("div",tt,[T(s.column_patch).tables?.length?(a(),n("div",st,[e[23]||(e[23]=l("span",{class:"ctx-key"},"tables:",-1)),l("div",lt,[(a(!0),n(h,null,v(T(s.column_patch).tables,o=>(a(),x(A,{key:`patch-table-${o}`,size:"small",effect:"plain"},{default:c(()=>[_(i(o),1)]),_:2},1024))),128))])])):u("",!0),T(s.column_patch).column_patches?(a(),n("div",at,[e[26]||(e[26]=l("span",{class:"ctx-key"},"column_patches:",-1)),l("div",ot,[(a(!0),n(h,null,v(T(s.column_patch).column_patches,(o,E)=>(a(),n("div",{key:`patch-${E}`,class:"patch-item"},[l("div",nt,i(E),1),o?.where?(a(),n("div",rt,[e[24]||(e[24]=l("b",null,"WHERE:",-1)),_(" "+i(o.where),1)])):u("",!0),o?.reason?(a(),n("div",it,[e[25]||(e[25]=l("b",null,"REASON:",-1)),_(" "+i(o.reason),1)])):u("",!0)]))),128))])])):u("",!0)])])):u("",!0),l("div",dt,[d(A,{size:"small",type:s.is_right===!0?"success":s.is_right===!1?"danger":"info"},{default:c(()=>[_(i(s.is_right===!0?"正确":s.is_right===!1?"错误":"未评价"),1)]),_:2},1032,["type"]),l("span",ct,i(M(s.created_at)),1)]),l("div",ut,[d(k,{modelValue:q[s.id].is_right,"onUpdate:modelValue":o=>q[s.id].is_right=o,placeholder:"评价",clearable:"",class:"feedback-select"},{default:c(()=>[d(r,{label:"正确",value:!0}),d(r,{label:"错误",value:!1})]),_:1},8,["modelValue","onUpdate:modelValue"]),d($,{modelValue:q[s.id].feedback,"onUpdate:modelValue":o=>q[s.id].feedback=o,placeholder:"填写反馈（可选）",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),d(j,{type:"primary",plain:"",loading:C.value.includes(s.id),onClick:o=>le(s.id)},{default:c(()=>[...e[28]||(e[28]=[_("保存反馈",-1)])]),_:1},8,["loading","onClick"])])]))),128))])),[[Y,O.value]])]),_:1},8,["modelValue","title"])])}}},bt=_e(_t,[["__scopeId","data-v-5f9097a2"]]);export{bt as default};
