import{_ as we,f as xe,c as _,a as u,b as l,w as a,g as Ve,h as x,t as d,E as v,m as H,r as p,j as m,k as he,o as i,u as Z,s as Ce,F as C,x as T,p as Te,n as r,i as D,v as ee}from"./index-CPm_9BR3.js";import{a as De,b as ze,c as te,d as Le,u as Ue,e as $e}from"./tableLevelPrompt-DnlKdy2I.js";import{g as Ie}from"./nlsqlTaskConfig-vN1Wt6V1.js";import"./index-DefhRm7t.js";const Se={class:"table-metadata-view"},Be={class:"card"},qe={class:"search-section"},Ee={class:"card"},Pe={class:"table-container"},Ne={class:"compact-pagination"},Fe={class:"pagination-content"},je={class:"record-count"},Re={key:0,class:"prompt-details"},Me={key:0,style:{"margin-top":"20px"}},Ae={key:1,style:{"margin-top":"20px"}},Ge={key:2,style:{"margin-top":"20px"}},He={key:3,style:{"margin-top":"20px"}},Je={key:4,style:{"margin-top":"20px"}},Ke={key:5,style:{"margin-top":"20px"}},Oe={__name:"Entity",setup(Qe){const F=m(!1),j=m(!1),J=m([]),R=m([]),z=m([]),P=m(!1),L=m(!1),n=m(null),N=m(!1),U=m(null),f=H({table_name:"",task_id:null}),s=H({id:null,table_name:"",task_id:null,table_description:"",is_active:!0}),c=H({page:1,page_size:10,total:0}),le={table_name:[{required:!0,message:"请输入表名称",trigger:"blur"}],task_id:[{required:!0,message:"请选择任务",trigger:"change"}]},$=m(""),I=m(""),S=m(""),B=m("");async function ae(){try{const o=await Ie({page:1,page_size:100});R.value=o.items||[]}catch(o){console.error("获取任务列表失败:",o),v.error("获取任务列表失败")}}async function b(){try{F.value=!0;const o={page:c.page,page_size:c.page_size};f.table_name&&(o.table_name=f.table_name),f.task_id&&(o.task_id=f.task_id),console.log("发送的参数:",o);const e=await De(o);J.value=e.data||e.items||[],c.total=e.pagination?.total||e.total||0}catch(o){console.error("获取提示词列表失败:",o),console.error("错误详情:",o.response?.data),v.error("获取提示词列表失败")}finally{F.value=!1}}let M=null;function oe(){M&&clearTimeout(M),M=setTimeout(()=>{c.page=1,b()},500)}function ne(){c.page=1,b()}function se(o){z.value=o}function ie(o){c.page_size=o,c.page=1,b()}function re(o){c.page=o,b()}async function ue(o){try{const e=await te(o.id);n.value=e.data||e,P.value=!0}catch(e){console.error("获取详情失败:",e),v.error("获取详情失败")}}function de(){N.value=!1,O(),L.value=!0}async function pe(o){try{N.value=!0;const e=await te(o.id),g=e.data||e;s.id=g.id,s.table_name=g.table_name,s.task_id=g.task_id,s.table_description=g.table_description,s.is_active=g.is_active,$.value=(g.query_scenarios||[]).join(`
`),I.value=(g.aggregation_scenarios||[]).join(`
`),S.value=(g.data_role||[]).join(`
`),B.value=(g.usage_not_scenarios||[]).join(`
`),L.value=!0}catch(e){console.error("获取编辑数据失败:",e),v.error("获取编辑数据失败")}}async function _e(){if(U.value)try{await U.value.validate(),j.value=!0;const o={table_name:s.table_name,task_id:parseInt(s.task_id,10),table_description:s.table_description,query_scenarios:$.value.split(`
`).filter(e=>e.trim()),aggregation_scenarios:I.value.split(`
`).filter(e=>e.trim()),data_role:S.value.split(`
`).filter(e=>e.trim()),usage_not_scenarios:B.value.split(`
`).filter(e=>e.trim()),is_active:s.is_active,system_config:n.value?.system_config||"",table_notes:n.value?.table_notes||[]};N.value?(await Ue(s.id,o),v.success("更新成功")):(await $e(o),v.success("创建成功")),L.value=!1,b()}catch(o){console.error("保存失败:",o),v.error(o.response?.data?.detail||"保存失败")}finally{j.value=!1}}async function ce(o){try{await ee.confirm(`确定要删除表 ${o.table_name} 的提示词吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Le(o.id),v.success("删除成功"),b()}catch(e){e!=="cancel"&&(console.error("删除失败:",e),v.error("删除失败"))}}async function me(){if(z.value.length===0){v.warning("请选择要删除的记录");return}try{await ee.confirm(`确定要删除选中的 ${z.value.length} 条记录吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const o=z.value.map(e=>e.id);await ze(o),v.success("批量删除成功"),b()}catch(o){o!=="cancel"&&(console.error("批量删除失败:",o),v.error("批量删除失败"))}}function K(o){v.info(`查看任务 ID: ${o}`)}function O(){s.id=null,s.table_name="",s.task_id=null,s.table_description="",s.is_active=!0,$.value="",I.value="",S.value="",B.value="",U.value&&U.value.resetFields()}function A(o){return o?new Date(o).toLocaleString("zh-CN"):"-"}return xe(()=>{ae(),b()}),(o,e)=>{const g=p("el-icon"),y=p("el-input"),Q=p("el-option"),W=p("el-select"),q=p("el-button"),k=p("el-table-column"),E=p("el-link"),V=p("el-tag"),X=p("el-divider"),ve=p("el-table"),ge=p("el-pagination"),w=p("el-form-item"),fe=p("el-switch"),be=p("el-form"),Y=p("el-dialog"),h=p("el-descriptions-item"),ye=p("el-descriptions"),ke=he("loading");return i(),_("div",Se,[u("div",Be,[e[22]||(e[22]=u("h2",{class:"card-title"},"表级别提示词管理",-1)),e[23]||(e[23]=u("p",{class:"page-desc"},"管理表级别提示词信息，支持按表名和任务ID筛选，可进行增删改查操作",-1)),u("div",qe,[l(y,{modelValue:f.table_name,"onUpdate:modelValue":e[0]||(e[0]=t=>f.table_name=t),placeholder:"搜索表名称",clearable:"",onInput:oe,class:"search-input"},{prefix:a(()=>[l(g,null,{default:a(()=>[l(Z(Ce))]),_:1})]),_:1},8,["modelValue"]),l(W,{modelValue:f.task_id,"onUpdate:modelValue":e[1]||(e[1]=t=>f.task_id=t),placeholder:"选择任务ID",clearable:"",onChange:ne,class:"task-select"},{default:a(()=>[(i(!0),_(C,null,T(R.value,t=>(i(),x(Q,{key:t.id,label:`${t.id} - ${t.description||"无描述"}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(q,{type:"primary",onClick:de,class:"create-btn"},{default:a(()=>[l(g,null,{default:a(()=>[l(Z(Te))]),_:1}),e[18]||(e[18]=r(" 新增提示词 ",-1))]),_:1}),l(q,{type:"danger",onClick:me,disabled:z.value.length===0,class:"batch-delete-btn"},{default:a(()=>[r(" 批量删除 ("+d(z.value.length)+") ",1)]),_:1},8,["disabled"])]),u("div",Ee,[u("div",Pe,[Ve((i(),x(ve,{data:J.value,style:{width:"100%"},onSelectionChange:se},{default:a(()=>[l(k,{type:"selection",width:"55"}),l(k,{prop:"id",label:"ID",width:"80"}),l(k,{prop:"table_name",label:"表名称","min-width":"180","show-overflow-tooltip":""}),l(k,{prop:"task_id",label:"任务ID",width:"100"},{default:a(t=>[l(E,{type:"primary",onClick:G=>K(t.row.task_id)},{default:a(()=>[r(d(t.row.task_id),1)]),_:2},1032,["onClick"])]),_:1}),l(k,{prop:"table_description",label:"表描述","min-width":"200","show-overflow-tooltip":""}),l(k,{prop:"is_active",label:"状态",width:"100"},{default:a(t=>[l(V,{type:t.row.is_active?"success":"info"},{default:a(()=>[r(d(t.row.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(k,{prop:"created_at",label:"创建时间",width:"180"},{default:a(t=>[r(d(A(t.row.created_at)),1)]),_:1}),l(k,{label:"操作",width:"180"},{default:a(t=>[l(E,{type:"primary",onClick:G=>ue(t.row)},{default:a(()=>[...e[19]||(e[19]=[r("查看",-1)])]),_:1},8,["onClick"]),l(X,{direction:"vertical"}),l(E,{type:"primary",onClick:G=>pe(t.row)},{default:a(()=>[...e[20]||(e[20]=[r("编辑",-1)])]),_:1},8,["onClick"]),l(X,{direction:"vertical"}),l(E,{type:"danger",onClick:G=>ce(t.row)},{default:a(()=>[...e[21]||(e[21]=[r("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ke,F.value]])])])]),u("div",Ne,[u("div",Fe,[u("span",je,d(c.total),1),l(ge,{"current-page":c.page,"onUpdate:currentPage":e[2]||(e[2]=t=>c.page=t),"page-size":c.page_size,"onUpdate:pageSize":e[3]||(e[3]=t=>c.page_size=t),total:c.total,"page-sizes":[10,20,50,100],size:"small",layout:"prev, pager, next, sizes",onSizeChange:ie,onCurrentChange:re,background:!1},null,8,["current-page","page-size","total"])])]),l(Y,{modelValue:L.value,"onUpdate:modelValue":e[13]||(e[13]=t=>L.value=t),title:N.value?"编辑表级别提示词":"新增表级别提示词",width:"900px",onClose:O},{footer:a(()=>[l(q,{onClick:e[12]||(e[12]=t=>L.value=!1)},{default:a(()=>[...e[28]||(e[28]=[r("取消",-1)])]),_:1}),l(q,{type:"primary",onClick:_e,loading:j.value},{default:a(()=>[...e[29]||(e[29]=[r("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(be,{model:s,rules:le,ref_key:"formRef",ref:U,"label-width":"120px"},{default:a(()=>[l(w,{label:"表名称",prop:"table_name"},{default:a(()=>[l(y,{modelValue:s.table_name,"onUpdate:modelValue":e[4]||(e[4]=t=>s.table_name=t),placeholder:"请输入表名称"},null,8,["modelValue"])]),_:1}),l(w,{label:"任务ID",prop:"task_id"},{default:a(()=>[l(W,{modelValue:s.task_id,"onUpdate:modelValue":e[5]||(e[5]=t=>s.task_id=t),placeholder:"请选择任务",style:{width:"100%"}},{default:a(()=>[(i(!0),_(C,null,T(R.value,t=>(i(),x(Q,{key:t.id,label:`${t.id} - ${t.description||"无描述"}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(w,{label:"表描述",prop:"table_description"},{default:a(()=>[l(y,{modelValue:s.table_description,"onUpdate:modelValue":e[6]||(e[6]=t=>s.table_description=t),type:"textarea",rows:3,placeholder:"请输入表描述"},null,8,["modelValue"])]),_:1}),l(w,{label:"查询场景"},{default:a(()=>[l(y,{modelValue:$.value,"onUpdate:modelValue":e[7]||(e[7]=t=>$.value=t),type:"textarea",rows:3,placeholder:"每行输入一个查询场景"},null,8,["modelValue"]),e[24]||(e[24]=u("div",{class:"help-text"},"每行输入一个查询场景，保存时会自动转换为数组",-1))]),_:1}),l(w,{label:"聚合场景"},{default:a(()=>[l(y,{modelValue:I.value,"onUpdate:modelValue":e[8]||(e[8]=t=>I.value=t),type:"textarea",rows:3,placeholder:"每行输入一个聚合场景"},null,8,["modelValue"]),e[25]||(e[25]=u("div",{class:"help-text"},"每行输入一个聚合场景，保存时会自动转换为数组",-1))]),_:1}),l(w,{label:"数据角色"},{default:a(()=>[l(y,{modelValue:S.value,"onUpdate:modelValue":e[9]||(e[9]=t=>S.value=t),type:"textarea",rows:2,placeholder:"每行输入一个数据角色"},null,8,["modelValue"]),e[26]||(e[26]=u("div",{class:"help-text"},"每行输入一个数据角色，保存时会自动转换为数组",-1))]),_:1}),l(w,{label:"使用例外"},{default:a(()=>[l(y,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=t=>B.value=t),type:"textarea",rows:2,placeholder:"每行输入一个使用例外"},null,8,["modelValue"]),e[27]||(e[27]=u("div",{class:"help-text"},"每行输入一个使用例外，保存时会自动转换为数组",-1))]),_:1}),l(w,{label:"状态"},{default:a(()=>[l(fe,{modelValue:s.is_active,"onUpdate:modelValue":e[11]||(e[11]=t=>s.is_active=t),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(Y,{modelValue:P.value,"onUpdate:modelValue":e[17]||(e[17]=t=>P.value=t),title:"表级别提示词详情",width:"900px"},{footer:a(()=>[l(q,{onClick:e[16]||(e[16]=t=>P.value=!1)},{default:a(()=>[...e[36]||(e[36]=[r("关闭",-1)])]),_:1})]),default:a(()=>[n.value?(i(),_("div",Re,[l(ye,{column:2,border:""},{default:a(()=>[l(h,{label:"ID"},{default:a(()=>[r(d(n.value.id),1)]),_:1}),l(h,{label:"表名称"},{default:a(()=>[r(d(n.value.table_name),1)]),_:1}),l(h,{label:"任务ID"},{default:a(()=>[l(E,{type:"primary",onClick:e[14]||(e[14]=t=>K(n.value.task_id))},{default:a(()=>[r(d(n.value.task_id),1)]),_:1})]),_:1}),l(h,{label:"状态"},{default:a(()=>[l(V,{type:n.value.is_active?"success":"info"},{default:a(()=>[r(d(n.value.is_active?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),l(h,{label:"创建时间",span:"2"},{default:a(()=>[r(d(A(n.value.created_at)),1)]),_:1}),l(h,{label:"更新时间",span:"2"},{default:a(()=>[r(d(A(n.value.updated_at)),1)]),_:1}),l(h,{label:"表描述",span:"2"},{default:a(()=>[r(d(n.value.table_description||"暂无描述"),1)]),_:1})]),_:1}),n.value.query_scenarios&&n.value.query_scenarios.length>0?(i(),_("div",Me,[e[30]||(e[30]=u("h4",null,"查询场景：",-1)),(i(!0),_(C,null,T(n.value.query_scenarios,t=>(i(),x(V,{key:t,style:{"margin-right":"10px","margin-bottom":"10px"}},{default:a(()=>[r(d(t),1)]),_:2},1024))),128))])):D("",!0),n.value.aggregation_scenarios&&n.value.aggregation_scenarios.length>0?(i(),_("div",Ae,[e[31]||(e[31]=u("h4",null,"聚合场景：",-1)),(i(!0),_(C,null,T(n.value.aggregation_scenarios,t=>(i(),x(V,{key:t,style:{"margin-right":"10px","margin-bottom":"10px"}},{default:a(()=>[r(d(t),1)]),_:2},1024))),128))])):D("",!0),n.value.data_role&&n.value.data_role.length>0?(i(),_("div",Ge,[e[32]||(e[32]=u("h4",null,"数据角色：",-1)),(i(!0),_(C,null,T(n.value.data_role,t=>(i(),x(V,{key:t,style:{"margin-right":"10px","margin-bottom":"10px"}},{default:a(()=>[r(d(t),1)]),_:2},1024))),128))])):D("",!0),n.value.usage_not_scenarios&&n.value.usage_not_scenarios.length>0?(i(),_("div",He,[e[33]||(e[33]=u("h4",null,"使用例外：",-1)),(i(!0),_(C,null,T(n.value.usage_not_scenarios,t=>(i(),x(V,{key:t,style:{"margin-right":"10px","margin-bottom":"10px"}},{default:a(()=>[r(d(t),1)]),_:2},1024))),128))])):D("",!0),n.value.system_config?(i(),_("div",Je,[e[34]||(e[34]=u("h4",null,"系统配置：",-1)),l(y,{modelValue:n.value.system_config,"onUpdate:modelValue":e[15]||(e[15]=t=>n.value.system_config=t),type:"textarea",rows:4,readonly:""},null,8,["modelValue"])])):D("",!0),n.value.table_notes&&n.value.table_notes.length>0?(i(),_("div",Ke,[e[35]||(e[35]=u("h4",null,"表注释：",-1)),(i(!0),_(C,null,T(n.value.table_notes,t=>(i(),x(V,{key:t,style:{"margin-right":"10px","margin-bottom":"10px"}},{default:a(()=>[r(d(t),1)]),_:2},1024))),128))])):D("",!0)])):D("",!0)]),_:1},8,["modelValue"])])}}},et=we(Oe,[["__scopeId","data-v-34f10b4b"]]);export{et as default};
