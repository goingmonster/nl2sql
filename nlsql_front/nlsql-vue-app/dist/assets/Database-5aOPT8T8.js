import{_ as ae,f as le,c as I,a as C,b as l,w as n,g as te,h as ne,i as oe,E as i,j as p,r,k as se,m as re,o as z,u as B,s as ue,p as ie,n as m,t as T,q as de,v as U}from"./index-CPm_9BR3.js";import{s as pe,g as me,a as ce,d as ge,b as fe,u as ve,c as _e}from"./tableMetadata-BYn0U9Y9.js";import"./index-DefhRm7t.js";const be={class:"database-view"},ye={class:"card"},he={class:"table-header"},we={class:"card"},Ce={class:"pagination-wrapper"},Ve={key:0,class:"batch-actions"},xe={__name:"Database",setup(Se){const x=p(!1),S=p(!1),y=p(!1),f=p(!1),c=p(""),h=p([]),w=p([]),V=p(),u=re({page:1,pageSize:20,total:0}),o=p({database_name:"",type:"",ip:"",port:5432,username:"",password:"",schema_name:"public"}),L={database_name:[{required:!0,message:"请输入数据库名称",trigger:"blur"},{max:100,message:"数据库名称长度不能超过 100 个字符",trigger:"blur"}],type:[{required:!0,message:"请选择数据库类型",trigger:"change"}],ip:[{required:!0,message:"请输入 IP 地址",trigger:"blur"},{pattern:/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,message:"请输入正确的 IP 地址格式",trigger:"blur"}],port:[{required:!0,message:"请输入端口号",trigger:"blur"},{type:"number",min:1,max:65535,message:"端口范围应在 1-65535 之间",trigger:"blur"}],username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度至少 6 位",trigger:"blur"}],schema_name:[{required:!0,message:"请输入 Schema 名称",trigger:"blur"}]};async function v(a=""){try{x.value=!0;const e={page:u.page,page_size:u.pageSize};let s;a?s=await pe({...e,keyword:a}):s=await me(e),h.value=s.items||[],u.total=s.total||0}catch(e){console.error("获取数据库配置列表失败:",e),i.error("获取数据库配置列表失败")}finally{x.value=!1}}let D=null;function E(){D&&clearTimeout(D),D=setTimeout(()=>{u.page=1,v(c.value)},500)}function P(a){w.value=a}function M(a){u.pageSize=a,u.page=1,v(c.value)}function N(a){u.page=a,v(c.value)}function $(){o.value={database_name:"",type:"",ip:"",port:5432,username:"",password:"",schema_name:"public"},f.value=!1,V.value?.clearValidate()}function R(a){f.value=!0,o.value={id:a.id,database_name:a.database_name,type:a.type,ip:a.ip,port:a.port,username:a.username,password:a.password,schema_name:a.schema_name},y.value=!0}async function Q(a){try{const e=h.value.findIndex(g=>g.id===a.id);e!==-1&&(h.value[e].scanning=!0),await U.confirm(`确定要扫描数据库 ${a.database_name} 的表结构吗？`,"扫描确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"});const s=await ce({db_config_id:a.id});s.success?i.success(s.message||"扫描成功"):i.error(s.message||"扫描失败")}catch(e){e!=="cancel"&&(console.error("扫描失败:",e),i.error(e.response?.data?.detail||"扫描失败"))}finally{const e=h.value.findIndex(s=>s.id===a.id);e!==-1&&(h.value[e].scanning=!1)}}async function j(a){try{await U.confirm(`确定要删除数据库配置 ${a.username}@${a.ip}:${a.port} 吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ge(a.id),i.success("删除成功"),v(c.value)}catch(e){e!=="cancel"&&(console.error("删除失败:",e),i.error("删除失败"))}}async function K(){if(w.value.length===0){i.warning("请选择要删除的记录");return}try{await U.confirm(`确定要删除选中的 ${w.value.length} 条记录吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const a=w.value.map(s=>s.id);console.log("要删除的 IDs:",a);const e=await fe(a);console.log("批量删除结果:",e),i.success("批量删除成功"),v(c.value)}catch(a){a!=="cancel"&&(console.error("批量删除失败:",a),console.error("错误详情:",a.response?.data),i.error(a.response?.data?.detail||"批量删除失败"))}}async function A(){if(V.value)try{await V.value.validate(),S.value=!0;const a={...o.value};f.value&&!a.password&&delete a.password,f.value?(await ve(a.id,a),i.success("更新成功")):(await _e(a),i.success("添加成功")),y.value=!1,$(),v(c.value)}catch(a){console.error(f.value?"更新失败:":"添加失败:",a),i.error(f.value?"更新失败":"添加失败")}finally{S.value=!1}}function F(a){return a?new Date(a).toLocaleString("zh-CN"):"-"}function G(){$()}return le(()=>{v()}),(a,e)=>{const s=r("el-icon"),g=r("el-input"),_=r("el-button"),d=r("el-table-column"),H=r("el-tag"),Y=r("el-table"),J=r("el-pagination"),b=r("el-form-item"),k=r("el-option"),O=r("el-select"),W=r("el-input-number"),X=r("el-form"),Z=r("el-dialog"),ee=se("loading");return z(),I("div",be,[C("div",ye,[e[14]||(e[14]=C("h2",{class:"card-title"},"数据库管理",-1)),e[15]||(e[15]=C("p",{class:"page-desc"},"管理您的数据源连接，支持多种数据库类型",-1)),C("div",he,[l(g,{modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=t=>c.value=t),placeholder:"搜索数据库名称或用户名",clearable:"",onInput:E,style:{width:"300px","margin-right":"20px"}},{prefix:n(()=>[l(s,null,{default:n(()=>[l(B(ue))]),_:1})]),_:1},8,["modelValue"]),l(_,{type:"primary",class:"btn-gradient",onClick:e[1]||(e[1]=t=>y.value=!0)},{default:n(()=>[l(s,null,{default:n(()=>[l(B(ie))]),_:1}),e[13]||(e[13]=m(" 添加数据库 ",-1))]),_:1})])]),C("div",we,[te((z(),ne(Y,{data:h.value,style:{width:"100%"},onSelectionChange:P},{default:n(()=>[l(d,{type:"selection",width:"55"}),l(d,{prop:"database_name",label:"数据库名称",width:"150"}),l(d,{prop:"ip",label:"主机地址"}),l(d,{prop:"port",label:"端口",width:"100"}),l(d,{prop:"username",label:"用户名"}),l(d,{prop:"schema_name",label:"Schema",width:"120"}),l(d,{prop:"type",label:"类型",width:"100"},{default:n(t=>[l(H,null,{default:n(()=>[m(T(t.row.type),1)]),_:2},1024)]),_:1}),l(d,{prop:"created_at",label:"创建时间",width:"180"},{default:n(t=>[m(T(F(t.row.created_at)),1)]),_:1}),l(d,{label:"操作",width:"240"},{default:n(t=>[l(_,{link:"",type:"primary",onClick:q=>R(t.row)},{default:n(()=>[...e[16]||(e[16]=[m("编辑",-1)])]),_:1},8,["onClick"]),l(_,{link:"",type:"warning",onClick:q=>Q(t.row),loading:t.row.scanning},{default:n(()=>[l(s,null,{default:n(()=>[l(B(de))]),_:1}),e[17]||(e[17]=m(" 扫描 ",-1))]),_:1},8,["onClick","loading"]),l(_,{link:"",type:"danger",onClick:q=>j(t.row)},{default:n(()=>[...e[18]||(e[18]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ee,x.value]]),C("div",Ce,[l(J,{"current-page":u.page,"onUpdate:currentPage":e[2]||(e[2]=t=>u.page=t),"page-size":u.pageSize,"onUpdate:pageSize":e[3]||(e[3]=t=>u.pageSize=t),total:u.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:M,onCurrentChange:N},null,8,["current-page","page-size","total"])]),w.value.length>0?(z(),I("div",Ve,[l(_,{type:"danger",onClick:K},{default:n(()=>[m(" 删除选中的 "+T(w.value.length)+" 条记录 ",1)]),_:1})])):oe("",!0)]),l(Z,{modelValue:y.value,"onUpdate:modelValue":e[12]||(e[12]=t=>y.value=t),title:f.value?"编辑数据库配置":"添加数据库配置",width:"500px",onClose:G},{footer:n(()=>[l(_,{onClick:e[11]||(e[11]=t=>y.value=!1)},{default:n(()=>[...e[19]||(e[19]=[m("取消",-1)])]),_:1}),l(_,{type:"primary",onClick:A,loading:S.value},{default:n(()=>[...e[20]||(e[20]=[m(" 确定 ",-1)])]),_:1},8,["loading"])]),default:n(()=>[l(X,{ref_key:"formRef",ref:V,model:o.value,rules:L,"label-width":"100px"},{default:n(()=>[l(b,{label:"数据库名称",prop:"database_name"},{default:n(()=>[l(g,{modelValue:o.value.database_name,"onUpdate:modelValue":e[4]||(e[4]=t=>o.value.database_name=t),placeholder:"请输入数据库名称"},null,8,["modelValue"])]),_:1}),l(b,{label:"数据库类型",prop:"type"},{default:n(()=>[l(O,{modelValue:o.value.type,"onUpdate:modelValue":e[5]||(e[5]=t=>o.value.type=t),placeholder:"选择数据库类型",style:{width:"100%"}},{default:n(()=>[l(k,{label:"PostgreSQL",value:"PG"}),l(k,{label:"ClickHouse",value:"CK"}),l(k,{label:"MySQL",value:"MYSQL"})]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"主机地址",prop:"ip"},{default:n(()=>[l(g,{modelValue:o.value.ip,"onUpdate:modelValue":e[6]||(e[6]=t=>o.value.ip=t),placeholder:"请输入 IP 地址"},null,8,["modelValue"])]),_:1}),l(b,{label:"端口",prop:"port"},{default:n(()=>[l(W,{modelValue:o.value.port,"onUpdate:modelValue":e[7]||(e[7]=t=>o.value.port=t),min:1,max:65535,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(b,{label:"用户名",prop:"username"},{default:n(()=>[l(g,{modelValue:o.value.username,"onUpdate:modelValue":e[8]||(e[8]=t=>o.value.username=t),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),l(b,{label:"密码",prop:"password"},{default:n(()=>[l(g,{modelValue:o.value.password,"onUpdate:modelValue":e[9]||(e[9]=t=>o.value.password=t),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1}),l(b,{label:"Schema",prop:"schema_name"},{default:n(()=>[l(g,{modelValue:o.value.schema_name,"onUpdate:modelValue":e[10]||(e[10]=t=>o.value.schema_name=t),placeholder:"请输入 Schema 名称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Be=ae(xe,[["__scopeId","data-v-dc784b84"]]);export{Be as default};
