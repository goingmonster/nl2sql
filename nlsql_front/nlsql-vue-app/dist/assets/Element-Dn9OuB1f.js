import{_ as De,f as Ue,c as _,a as p,b as a,w as o,J as Te,g as ze,h as x,t as d,E as y,m as G,r as f,j as w,k as $e,o as i,u as oe,s as Be,F as C,x as N,n as r,p as Fe,i as Le,v as se}from"./index-CPm_9BR3.js";import{a as Pe,b as Ae,c as ie,d as Ie,u as Ee,e as Re}from"./tableFieldPrompt-CYrLLJ5i.js";import{a as Me}from"./tableLevelPrompt-DnlKdy2I.js";import{g as Ye}from"./nlsqlTaskConfig-vN1Wt6V1.js";import"./index-DefhRm7t.js";const je={class:"table-metadata-view"},Ke={class:"card search-card"},Ge={class:"search-section"},He={class:"card table-card"},Qe={class:"table-container"},We={class:"compact-pagination"},Xe={class:"pagination-content"},Ze={class:"record-count"},el={key:0,class:"view-detail-wrap"},ll={class:"view-section"},tl={key:0,class:"tag-list"},al={key:1,class:"empty-text"},nl={class:"view-section"},ol={key:0,class:"tag-list"},sl={key:1,class:"empty-text"},il={class:"view-section"},rl={key:0,class:"tag-list"},ul={key:1,class:"empty-text"},dl={class:"view-section"},_l={key:0,class:"tag-list"},pl={key:1,class:"empty-text"},fl={class:"view-section"},ml={key:0,class:"sample-block"},cl={key:1,class:"empty-text"},gl={__name:"Element",setup(bl){const A=w(!1),I=w(!1),E=w([]),R=w([]),B=w([]),J=w([]),H=w(null),U=w(!1),F=w(!1),O=w(!1),T=w(null),u=w(null),b=G({table_name:"",task_id:null}),m=G({page:1,page_size:10,total:0}),l=G({id:null,nlsql_task_id:null,table_level_prompt_id:null,field_name:"",business_meaning:"",data_format:"",field_description:"",query_scenarios:"",aggregation_scenarios:"",rules:"",database_usage:"",field_type:"",null_rate:"",unique_count:null,sample_values_text:""}),re={nlsql_task_id:[{required:!0,message:"请选择任务",trigger:"change"}],field_name:[{required:!0,message:"请输入字段名",trigger:"blur"}]};async function ue(){try{const t=await Ye({page:1,page_size:100});R.value=t.items||t.data||[]}catch(t){console.error("获取任务列表失败:",t),y.error("获取任务列表失败")}}async function M(t){if(!t){B.value=[];return}try{const e=await Me({page:1,page_size:100,task_id:t});B.value=e.data||e.items||[]}catch(e){console.error("获取表级提示词选项失败:",e),B.value=[]}}async function V(){try{A.value=!0;const t={page:m.page,page_size:m.page_size};b.table_name&&(t.table_name=b.table_name),b.task_id&&(t.task_id=b.task_id);const e=await Pe(t);E.value=e.data||e.items||[],m.total=e.pagination?.total||e.total||0,J.value=[],H.value?.clearSelection()}catch(t){console.error("获取字段提示词列表失败:",t),y.error("获取字段提示词列表失败")}finally{A.value=!1}}function Q(){m.page=1,V()}function de(){b.table_name="",b.task_id=null,m.page=1,V()}function _e(){m.page=1,V()}function pe(t){J.value=t}function fe(t){m.page_size=t,m.page=1,V()}function me(t){m.page=t,V()}async function W(){await V(),E.value.length===0&&m.page>1&&(m.page-=1,await V())}function ce(){O.value=!1,ee(),M(b.task_id),b.task_id&&(l.nlsql_task_id=b.task_id),U.value=!0}async function ge(t){try{O.value=!0;const e=await ie(t.id),s=e.data||e;l.id=s.id,l.nlsql_task_id=s.nlsql_task_id,l.table_level_prompt_id=s.table_level_prompt_id,l.field_name=s.field_name||"",l.business_meaning=s.business_meaning||"",l.data_format=s.data_format||"",l.field_description=s.field_description||"",l.query_scenarios=L(s.query_scenarios),l.aggregation_scenarios=L(s.aggregation_scenarios),l.rules=L(s.rules),l.database_usage=L(s.database_usage),l.field_type=s.field_type||"",l.null_rate=s.null_rate||"",l.unique_count=Number.isInteger(s.unique_count)?s.unique_count:null,l.sample_values_text=qe(s.sample_values),await M(s.nlsql_task_id),U.value=!0}catch(e){console.error("获取字段提示词详情失败:",e),y.error("获取字段提示词详情失败")}}async function be(t){try{const e=await ie(t.id);u.value=e.data||e,F.value=!0}catch(e){console.error("获取字段提示词详情失败:",e),y.error("获取字段提示词详情失败")}}async function ve(t){try{await se.confirm(`确定删除字段提示词 #${t.id}（${t.field_name}）吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ie(t.id),y.success("删除成功"),await W()}catch(e){e!=="cancel"&&(console.error("删除字段提示词失败:",e),y.error(e.response?.data?.detail||"删除失败"))}}async function ye(){if(J.value.length===0){y.warning("请选择要删除的记录");return}try{await se.confirm(`确定删除选中的 ${J.value.length} 条记录吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=J.value.map(e=>e.id).filter(e=>Number.isFinite(e));await Ae(t),y.success("批量删除成功"),await W()}catch(t){t!=="cancel"&&(console.error("批量删除失败:",t),y.error(t.response?.data?.detail||"批量删除失败"))}}async function we(t){l.table_level_prompt_id=null,await M(t)}async function ke(){if(T.value)try{if(await T.value.validate(),I.value=!0,O.value){const t=he();await Ee(l.id,t),y.success("更新成功")}else{const t=Ve();await Re(t),y.success("创建成功")}U.value=!1,await V()}catch(t){console.error("保存字段提示词失败:",t),y.error(t.response?.data?.detail||t.message||"保存失败")}finally{I.value=!1}}function Ve(){return{nlsql_task_id:Number(l.nlsql_task_id),table_level_prompt_id:l.table_level_prompt_id?Number(l.table_level_prompt_id):null,field_name:l.field_name.trim(),business_meaning:k(l.business_meaning),data_format:k(l.data_format),field_description:k(l.field_description),query_scenarios:S(l.query_scenarios),aggregation_scenarios:S(l.aggregation_scenarios),rules:S(l.rules),database_usage:S(l.database_usage),field_type:k(l.field_type),null_rate:k(l.null_rate),unique_count:l.unique_count===null?null:Number(l.unique_count),sample_values:X(l.sample_values_text)}}function he(){return{business_meaning:k(l.business_meaning),data_format:k(l.data_format),field_description:k(l.field_description),query_scenarios:S(l.query_scenarios),aggregation_scenarios:S(l.aggregation_scenarios),rules:S(l.rules),database_usage:S(l.database_usage),field_type:k(l.field_type),null_rate:k(l.null_rate),unique_count:l.unique_count===null?null:Number(l.unique_count),sample_values:X(l.sample_values_text)}}function k(t){return(t||"").trim()||null}function S(t){const e=(t||"").trim();if(!e)return null;try{const s=JSON.parse(e);return JSON.stringify(s)}catch{const c=e.split(`
`).map(z=>z.trim()).filter(Boolean);return c.length>0?JSON.stringify(c):null}}function X(t){const e=(t||"").trim();if(!e)return[];try{const s=JSON.parse(e);return Array.isArray(s)?s:[s]}catch{return e.split(`
`).map(c=>c.trim()).filter(Boolean)}}function L(t){if(t==null||t==="")return"";if(typeof t!="string")return JSON.stringify(t,null,2);try{const e=JSON.parse(t);return JSON.stringify(e,null,2)}catch{return t}}function qe(t){return t?JSON.stringify(t,null,2):""}function h(t){if(t==null||t==="")return[];if(Array.isArray(t))return t.map(e=>String(e)).filter(Boolean);if(typeof t=="string")try{const e=JSON.parse(t);return Array.isArray(e)?e.map(s=>String(s)).filter(Boolean):e&&typeof e=="object"?[JSON.stringify(e)]:[String(e)]}catch{return t.split(`
`).map(s=>s.trim()).filter(Boolean)}return typeof t=="object"?[JSON.stringify(t)]:[String(t)]}function Z(t){return t?Array.isArray(t)?t.map(e=>String(e)).filter(Boolean):h(t):[]}function ee(){l.id=null,l.nlsql_task_id=null,l.table_level_prompt_id=null,l.field_name="",l.business_meaning="",l.data_format="",l.field_description="",l.query_scenarios="",l.aggregation_scenarios="",l.rules="",l.database_usage="",l.field_type="",l.null_rate="",l.unique_count=null,l.sample_values_text="",T.value&&T.value.resetFields()}function Y(t){return t?new Date(t).toLocaleString("zh-CN"):"-"}return Ue(async()=>{await ue(),await V()}),(t,e)=>{const s=f("el-icon"),c=f("el-input"),z=f("el-option"),j=f("el-select"),D=f("el-button"),q=f("el-table-column"),K=f("el-link"),le=f("el-divider"),xe=f("el-table"),Se=f("el-pagination"),g=f("el-form-item"),P=f("el-col"),te=f("el-row"),Ce=f("el-input-number"),Ne=f("el-form"),ae=f("el-dialog"),v=f("el-descriptions-item"),Je=f("el-descriptions"),$=f("el-tag"),Oe=$e("loading");return i(),_("div",je,[p("div",Ke,[e[25]||(e[25]=p("h2",{class:"card-title"},"字段提示词管理",-1)),e[26]||(e[26]=p("p",{class:"page-desc"},"支持按表名和任务筛选，提供字段提示词分页查询、新增、修改、单删与批量删除",-1)),p("div",Ge,[a(c,{modelValue:b.table_name,"onUpdate:modelValue":e[0]||(e[0]=n=>b.table_name=n),placeholder:"搜索表名",clearable:"",class:"search-input",onKeyup:Te(Q,["enter"])},{prefix:o(()=>[a(s,null,{default:o(()=>[a(oe(Be))]),_:1})]),_:1},8,["modelValue"]),a(j,{modelValue:b.task_id,"onUpdate:modelValue":e[1]||(e[1]=n=>b.task_id=n),placeholder:"选择任务",clearable:"",class:"task-select",onChange:_e},{default:o(()=>[(i(!0),_(C,null,N(R.value,n=>(i(),x(z,{key:n.id,label:`${n.id} - ${n.description||"无描述"}`,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(D,{type:"primary",onClick:Q},{default:o(()=>[...e[22]||(e[22]=[r("查询",-1)])]),_:1}),a(D,{onClick:de},{default:o(()=>[...e[23]||(e[23]=[r("重置",-1)])]),_:1}),a(D,{type:"primary",onClick:ce},{default:o(()=>[a(s,null,{default:o(()=>[a(oe(Fe))]),_:1}),e[24]||(e[24]=r(" 新增 ",-1))]),_:1}),a(D,{type:"danger",disabled:J.value.length===0,onClick:ye},{default:o(()=>[r(" 批量删除 ("+d(J.value.length)+") ",1)]),_:1},8,["disabled"])])]),p("div",He,[p("div",Qe,[ze((i(),x(xe,{ref_key:"tableRef",ref:H,data:E.value,style:{width:"100%"},onSelectionChange:pe},{default:o(()=>[a(q,{type:"selection",width:"55"}),a(q,{prop:"id",label:"ID",width:"90"}),a(q,{prop:"table_name",label:"表名","min-width":"180","show-overflow-tooltip":""}),a(q,{prop:"nlsql_task_id",label:"任务ID",width:"100"}),a(q,{prop:"field_name",label:"字段名","min-width":"160","show-overflow-tooltip":""}),a(q,{prop:"business_meaning",label:"业务含义","min-width":"180","show-overflow-tooltip":""}),a(q,{prop:"field_type",label:"字段类型",width:"120","show-overflow-tooltip":""}),a(q,{prop:"updated_at",label:"更新时间",width:"180"},{default:o(n=>[r(d(Y(n.row.updated_at)),1)]),_:1}),a(q,{label:"操作",width:"190",fixed:"right"},{default:o(n=>[a(K,{type:"primary",onClick:ne=>be(n.row)},{default:o(()=>[...e[27]||(e[27]=[r("查看",-1)])]),_:1},8,["onClick"]),a(le,{direction:"vertical"}),a(K,{type:"primary",onClick:ne=>ge(n.row)},{default:o(()=>[...e[28]||(e[28]=[r("编辑",-1)])]),_:1},8,["onClick"]),a(le,{direction:"vertical"}),a(K,{type:"danger",onClick:ne=>ve(n.row)},{default:o(()=>[...e[29]||(e[29]=[r("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Oe,A.value]])])]),p("div",We,[p("div",Xe,[p("span",Ze,"共 "+d(m.total)+" 条",1),a(Se,{"current-page":m.page,"onUpdate:currentPage":e[2]||(e[2]=n=>m.page=n),"page-size":m.page_size,"onUpdate:pageSize":e[3]||(e[3]=n=>m.page_size=n),total:m.total,"page-sizes":[10,20,50,100],size:"small",layout:"prev, pager, next, sizes",background:!1,onSizeChange:fe,onCurrentChange:me},null,8,["current-page","page-size","total"])])]),a(ae,{modelValue:U.value,"onUpdate:modelValue":e[19]||(e[19]=n=>U.value=n),title:O.value?"编辑字段提示词":"新增字段提示词",width:"920px",onClose:ee},{footer:o(()=>[a(D,{onClick:e[18]||(e[18]=n=>U.value=!1)},{default:o(()=>[...e[30]||(e[30]=[r("取消",-1)])]),_:1}),a(D,{type:"primary",loading:I.value,onClick:ke},{default:o(()=>[...e[31]||(e[31]=[r("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[a(Ne,{ref_key:"formRef",ref:T,model:l,rules:re,"label-width":"140px"},{default:o(()=>[a(te,{gutter:16},{default:o(()=>[a(P,{span:12},{default:o(()=>[a(g,{label:"任务ID",prop:"nlsql_task_id"},{default:o(()=>[a(j,{modelValue:l.nlsql_task_id,"onUpdate:modelValue":e[4]||(e[4]=n=>l.nlsql_task_id=n),placeholder:"请选择任务",style:{width:"100%"},disabled:O.value,onChange:we},{default:o(()=>[(i(!0),_(C,null,N(R.value,n=>(i(),x(z,{key:n.id,label:`${n.id} - ${n.description||"无描述"}`,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),a(P,{span:12},{default:o(()=>[a(g,{label:"表级提示词ID",prop:"table_level_prompt_id"},{default:o(()=>[a(j,{modelValue:l.table_level_prompt_id,"onUpdate:modelValue":e[5]||(e[5]=n=>l.table_level_prompt_id=n),placeholder:"可选：关联表级提示词",clearable:"",filterable:"",style:{width:"100%"},disabled:O.value},{default:o(()=>[(i(!0),_(C,null,N(B.value,n=>(i(),x(z,{key:n.id,label:`${n.table_name||"未知表"} (#${n.id})`,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),a(g,{label:"字段名",prop:"field_name"},{default:o(()=>[a(c,{modelValue:l.field_name,"onUpdate:modelValue":e[6]||(e[6]=n=>l.field_name=n),disabled:O.value,placeholder:"例如：order_id"},null,8,["modelValue","disabled"])]),_:1}),a(g,{label:"业务含义",prop:"business_meaning"},{default:o(()=>[a(c,{modelValue:l.business_meaning,"onUpdate:modelValue":e[7]||(e[7]=n=>l.business_meaning=n),placeholder:"请输入业务含义"},null,8,["modelValue"])]),_:1}),a(g,{label:"数据格式",prop:"data_format"},{default:o(()=>[a(c,{modelValue:l.data_format,"onUpdate:modelValue":e[8]||(e[8]=n=>l.data_format=n),placeholder:"例如：YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),a(g,{label:"字段描述",prop:"field_description"},{default:o(()=>[a(c,{modelValue:l.field_description,"onUpdate:modelValue":e[9]||(e[9]=n=>l.field_description=n),type:"textarea",rows:2,placeholder:"请输入字段描述"},null,8,["modelValue"])]),_:1}),a(te,{gutter:16},{default:o(()=>[a(P,{span:12},{default:o(()=>[a(g,{label:"字段类型",prop:"field_type"},{default:o(()=>[a(c,{modelValue:l.field_type,"onUpdate:modelValue":e[10]||(e[10]=n=>l.field_type=n),placeholder:"例如：varchar"},null,8,["modelValue"])]),_:1})]),_:1}),a(P,{span:12},{default:o(()=>[a(g,{label:"空值率",prop:"null_rate"},{default:o(()=>[a(c,{modelValue:l.null_rate,"onUpdate:modelValue":e[11]||(e[11]=n=>l.null_rate=n),placeholder:"例如：0.12"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(g,{label:"唯一值数量",prop:"unique_count"},{default:o(()=>[a(Ce,{modelValue:l.unique_count,"onUpdate:modelValue":e[12]||(e[12]=n=>l.unique_count=n),min:0,step:1,controls:!1,style:{width:"100%"},placeholder:"可选"},null,8,["modelValue"])]),_:1}),a(g,{label:"查询场景(JSON)"},{default:o(()=>[a(c,{modelValue:l.query_scenarios,"onUpdate:modelValue":e[13]||(e[13]=n=>l.query_scenarios=n),type:"textarea",rows:3,placeholder:'可输入JSON数组字符串，如 ["按用户查订单"]'},null,8,["modelValue"])]),_:1}),a(g,{label:"聚合场景(JSON)"},{default:o(()=>[a(c,{modelValue:l.aggregation_scenarios,"onUpdate:modelValue":e[14]||(e[14]=n=>l.aggregation_scenarios=n),type:"textarea",rows:3,placeholder:'可输入JSON数组字符串，如 ["按月统计"]'},null,8,["modelValue"])]),_:1}),a(g,{label:"规则(JSON)"},{default:o(()=>[a(c,{modelValue:l.rules,"onUpdate:modelValue":e[15]||(e[15]=n=>l.rules=n),type:"textarea",rows:3,placeholder:'可输入JSON数组字符串，如 ["金额>=0"]'},null,8,["modelValue"])]),_:1}),a(g,{label:"数据库使用方式(JSON)"},{default:o(()=>[a(c,{modelValue:l.database_usage,"onUpdate:modelValue":e[16]||(e[16]=n=>l.database_usage=n),type:"textarea",rows:3,placeholder:'可输入JSON数组字符串，如 ["作为过滤条件"]'},null,8,["modelValue"])]),_:1}),a(g,{label:"样例值(JSON数组)"},{default:o(()=>[a(c,{modelValue:l.sample_values_text,"onUpdate:modelValue":e[17]||(e[17]=n=>l.sample_values_text=n),type:"textarea",rows:3,placeholder:'可输入JSON数组，如 ["A001", "A002"]；也支持每行一个值'},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(ae,{modelValue:F.value,"onUpdate:modelValue":e[21]||(e[21]=n=>F.value=n),title:"字段提示词详情",width:"980px"},{footer:o(()=>[a(D,{onClick:e[20]||(e[20]=n=>F.value=!1)},{default:o(()=>[...e[37]||(e[37]=[r("关闭",-1)])]),_:1})]),default:o(()=>[u.value?(i(),_("div",el,[a(Je,{column:2,border:""},{default:o(()=>[a(v,{label:"ID"},{default:o(()=>[r(d(u.value.id),1)]),_:1}),a(v,{label:"表名"},{default:o(()=>[r(d(u.value.table_name||"-"),1)]),_:1}),a(v,{label:"任务ID"},{default:o(()=>[r(d(u.value.nlsql_task_id||"-"),1)]),_:1}),a(v,{label:"表级提示词ID"},{default:o(()=>[r(d(u.value.table_level_prompt_id||"-"),1)]),_:1}),a(v,{label:"字段名"},{default:o(()=>[r(d(u.value.field_name||"-"),1)]),_:1}),a(v,{label:"字段类型"},{default:o(()=>[r(d(u.value.field_type||"-"),1)]),_:1}),a(v,{label:"空值率"},{default:o(()=>[r(d(u.value.null_rate||"-"),1)]),_:1}),a(v,{label:"唯一值数量"},{default:o(()=>[r(d(u.value.unique_count??"-"),1)]),_:1}),a(v,{label:"创建时间"},{default:o(()=>[r(d(Y(u.value.created_at)),1)]),_:1}),a(v,{label:"更新时间"},{default:o(()=>[r(d(Y(u.value.updated_at)),1)]),_:1}),a(v,{label:"业务含义",span:2},{default:o(()=>[r(d(u.value.business_meaning||"-"),1)]),_:1}),a(v,{label:"数据格式",span:2},{default:o(()=>[r(d(u.value.data_format||"-"),1)]),_:1}),a(v,{label:"字段描述",span:2},{default:o(()=>[r(d(u.value.field_description||"-"),1)]),_:1})]),_:1}),p("div",ll,[e[32]||(e[32]=p("h4",null,"查询场景",-1)),h(u.value.query_scenarios).length?(i(),_("div",tl,[(i(!0),_(C,null,N(h(u.value.query_scenarios),n=>(i(),x($,{key:`q-${n}`,class:"tag-item"},{default:o(()=>[r(d(n),1)]),_:2},1024))),128))])):(i(),_("div",al,"暂无"))]),p("div",nl,[e[33]||(e[33]=p("h4",null,"聚合场景",-1)),h(u.value.aggregation_scenarios).length?(i(),_("div",ol,[(i(!0),_(C,null,N(h(u.value.aggregation_scenarios),n=>(i(),x($,{key:`a-${n}`,type:"success",class:"tag-item"},{default:o(()=>[r(d(n),1)]),_:2},1024))),128))])):(i(),_("div",sl,"暂无"))]),p("div",il,[e[34]||(e[34]=p("h4",null,"规则",-1)),h(u.value.rules).length?(i(),_("div",rl,[(i(!0),_(C,null,N(h(u.value.rules),n=>(i(),x($,{key:`r-${n}`,type:"warning",class:"tag-item"},{default:o(()=>[r(d(n),1)]),_:2},1024))),128))])):(i(),_("div",ul,"暂无"))]),p("div",dl,[e[35]||(e[35]=p("h4",null,"数据库使用方式",-1)),h(u.value.database_usage).length?(i(),_("div",_l,[(i(!0),_(C,null,N(h(u.value.database_usage),n=>(i(),x($,{key:`d-${n}`,type:"info",class:"tag-item"},{default:o(()=>[r(d(n),1)]),_:2},1024))),128))])):(i(),_("div",pl,"暂无"))]),p("div",fl,[e[36]||(e[36]=p("h4",null,"样例值",-1)),Z(u.value.sample_values).length?(i(),_("div",ml,[(i(!0),_(C,null,N(Z(u.value.sample_values),n=>(i(),x($,{key:`s-${n}`,effect:"plain",class:"tag-item"},{default:o(()=>[r(d(n),1)]),_:2},1024))),128))])):(i(),_("div",cl,"暂无"))])])):Le("",!0)]),_:1},8,["modelValue"])])}}},hl=De(gl,[["__scopeId","data-v-eed8c99e"]]);export{hl as default};
