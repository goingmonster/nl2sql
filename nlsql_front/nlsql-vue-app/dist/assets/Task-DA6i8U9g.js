import{_ as $e,f as xe,c as v,a as z,b as a,w as o,g as ze,h as C,E as i,r as u,k as De,j as f,m as G,o as c,u as y,p as Ne,n as s,F as D,x as N,s as Me,t as g,A as Ee,B as Se,C as Pe,D as Re,G as Be,H as Ue,I as Oe,z as Ie,i as Q,v as Fe}from"./index-CPm_9BR3.js";import{g as ke,u as qe,c as je,d as Ae}from"./nlsqlTaskConfig-vN1Wt6V1.js";import{g as Ge,e as H}from"./tableMetadata-BYn0U9Y9.js";import{g as Qe}from"./llmConfig-D4kKmIJP.js";import{g as He}from"./promptConfig-DAy8NaTW.js";import{r as Je}from"./index-DefhRm7t.js";import{g as Ke}from"./tableLevelPrompt-DnlKdy2I.js";import{g as We}from"./tableFieldPrompt-CYrLLJ5i.js";import{g as Xe}from"./tableFieldRelation-DjRPEoda.js";const Ye=J=>Je({url:`/metadata/scan/${J}`,method:"post",timeout:18e4}),Ze={class:"task-container"},el={class:"task-header"},ll={class:"filter-section"},al={class:"task-table"},tl={class:"pagination"},ol={key:0,class:"task-detail"},nl={key:0,class:"selected-tables"},il={__name:"Task",setup(J){const O=f(!1),I=f(!1),M=f(!1),F=f(!1),k=f(null),p=f(null),V=f(!1),q=f(!1),d=f([]),K=f([]),P=f([]),R=f([]),j=f([]),E=f([]),w=G({status:"",llm_config_id:"",db_config_id:"",description:""}),b=G({page:1,page_size:20,total:0}),n=G({id:null,db_config_id:null,llm_config_id:null,user_prompt_config_id:null,select_tables:[],description:""}),ae={db_config_id:[{required:!0,message:"请选择数据库连接",trigger:"change"}],llm_config_id:[{required:!0,message:"请选择LLM配置",trigger:"change"}],user_prompt_config_id:[{required:!0,message:"请选择提示词配置",trigger:"change"}]},W=l=>({1:"info",2:"warning",3:"primary",4:"success",5:"success"})[l]||"info",X=l=>({1:"初始化",2:"提取元数据",3:"生成表提示词",4:"生成字段提示词",5:"完成"})[l]||"未知状态",B=l=>l?new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-",m=async()=>{O.value=!0;try{const l={page:b.page,page_size:b.page_size,...w};Object.keys(l).forEach(r=>{(l[r]===""||l[r]===null||l[r]===void 0)&&delete l[r]});const e=await ke(l);K.value=e.items||[],b.total=e.total||0}catch(l){console.error("获取任务列表失败:",l),i.error("获取任务列表失败")}finally{O.value=!1}},Y=async()=>{try{const l=await Ge({page:1,page_size:50}),e=await Qe({page:1,page_size:50}),r=await He({page:1,page_size:50});P.value=l.items||[],R.value=e.data||[],j.value=r.data||[],console.log("Database configs:",P.value.length),console.log("LLM configs:",R.value.length),console.log("Prompt configs:",j.value.length)}catch(l){console.error("获取配置失败:",l),i.error("获取配置失败")}},Z=async l=>{if(!l){E.value=[],n.select_tables=[];return}try{const e=await H({db_config_id:l,page:1,page_size:50});E.value=e.items||[],V.value||(n.select_tables=[])}catch(e){console.error("获取表列表失败:",e),i.error("获取表列表失败")}},te=async l=>{if(!n.db_config_id){E.value=[];return}try{q.value=!0;const e={db_config_id:n.db_config_id,page:1,page_size:50};l&&(e.table_name=l);const r=await H(e);E.value=r.items||[]}catch(e){console.error("搜索表列表失败:",e),i.error("搜索表列表失败")}finally{q.value=!1}},oe=async()=>{if(!(!n.select_tables||n.select_tables.length===0||!n.db_config_id))try{const e=(await H({db_config_id:n.db_config_id,page:1,page_size:200})).items||[],r=new Set(e.map(_=>_.id)),T=n.select_tables.filter(_=>!r.has(_));T.length>0&&console.log("有已选择的表不在当前列表中，需要单独查询:",T),E.value=e}catch(l){console.error("加载已选择表信息失败:",l)}},ne=()=>{V.value=!1,Object.assign(n,{id:null,db_config_id:null,llm_config_id:null,user_prompt_config_id:null,select_tables:[],description:""}),M.value=!0},ie=async l=>{V.value=!0;try{n.id=l.id,n.db_config_id=l.db_config_id,n.llm_config_id=l.llm_config_id,n.user_prompt_config_id=l.user_prompt_config_id,n.select_tables=l.select_tables||[],n.description=l.description||"",n.db_config_id&&(await Z(n.db_config_id),await oe()),M.value=!0}catch(e){console.error("准备编辑任务失败:",e),i.error("准备编辑任务失败")}},se=async()=>{if(k.value)try{await k.value.validate(),I.value=!0;const l={db_config_id:parseInt(n.db_config_id,10),llm_config_id:parseInt(n.llm_config_id,10),user_prompt_config_id:parseInt(n.user_prompt_config_id,10),select_tables:n.select_tables.map(e=>parseInt(e,10)),description:n.description||null};if(!l.db_config_id||!l.llm_config_id||!l.user_prompt_config_id){i.error("请选择所有必填的配置");return}console.log("提交的数据:",l),V.value?(await qe(n.id,l),i.success("任务更新成功")):(await je(l),i.success("任务创建成功")),M.value=!1,Object.assign(n,{id:null,db_config_id:null,llm_config_id:null,user_prompt_config_id:null,select_tables:[],description:""}),m()}catch(l){console.error(`${V.value?"更新":"创建"}任务失败:`,l),console.error("错误详情:",l.response?.data),i.error(l.response?.data?.detail||`${V.value?"更新":"创建"}任务失败`)}finally{I.value=!1}},de=l=>{p.value=l,F.value=!0},re=(l,e)=>{switch(l){case"view":de(e);break;case"scan":ue(e);break;case"generateTablePrompt":ce(e);break;case"generateFieldPrompt":_e(e);break;case"generateRelationPrompt":pe(e);break;case"edit":ie(e);break;case"delete":fe(e);break}},ue=async l=>{try{d.value=[...d.value,l.id],i.info(`任务 ${l.id} 正在提取元数据，耗时可能较长，请稍候...`);const e=await Ye(l.id);i.success(e.message||`任务 ${l.id} 元数据扫描成功`),m()}catch(e){if(console.error("扫描元数据失败:",e),e.code==="ECONNABORTED"){i.error(`任务 ${l.id} 提取元数据超时，请稍后查看任务状态或重试`);return}i.error(e.response?.data?.detail||`扫描任务 ${l.id} 元数据失败`)}finally{d.value=d.value.filter(e=>e!==l.id)}},ce=async l=>{try{d.value=[...d.value,l.id],i.info(`任务 ${l.id} 正在生成表级别提示词，耗时可能较长，请稍候...`);const e=await Ke(l.id);i.success(e.message||`任务 ${l.id} 生成表级别提示词成功`),m()}catch(e){if(console.error("生成表级别提示词失败:",e),e.code==="ECONNABORTED"){i.error(`任务 ${l.id} 生成表级别提示词超时，请稍后查看任务状态或重试`);return}i.error(e.response?.data?.detail||`任务 ${l.id} 生成表级别提示词失败`)}finally{d.value=d.value.filter(e=>e!==l.id)}},_e=async l=>{try{d.value=[...d.value,l.id],i.info(`任务 ${l.id} 正在生成字段提示词，耗时可能较长，请稍候...`);const e=await We(l.id);i.success(e.message||`任务 ${l.id} 生成字段提示词成功`),m()}catch(e){if(console.error("生成字段提示词失败:",e),e.code==="ECONNABORTED"){i.error(`任务 ${l.id} 生成字段提示词超时，请稍后查看任务状态或重试`);return}i.error(e.response?.data?.detail||`任务 ${l.id} 生成字段提示词失败`)}finally{d.value=d.value.filter(e=>e!==l.id)}},pe=async l=>{try{d.value=[...d.value,l.id],i.info(`任务 ${l.id} 正在生成关联关系提示词，耗时可能较长，请稍候...`);const e=await Xe(l.id);i.success(e.message||`任务 ${l.id} 生成关联关系提示词成功`),m()}catch(e){if(console.error("生成关联关系提示词失败:",e),e.code==="ECONNABORTED"){i.error(`任务 ${l.id} 生成关联关系提示词超时，请稍后查看任务状态或重试`);return}i.error(e.response?.data?.detail||`任务 ${l.id} 生成关联关系提示词失败`)}finally{d.value=d.value.filter(e=>e!==l.id)}},fe=l=>{Fe.confirm(`确定要删除ID为 "${l.id}" 的任务吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Ae(l.id),i.success("任务删除成功"),m()}catch(e){console.error("删除任务失败:",e),i.error("删除任务失败")}})},me=l=>{b.page_size=l,b.page=1,m()},ge=l=>{b.page=l,m()};return xe(()=>{m(),Y()}),(l,e)=>{const r=u("el-icon"),T=u("el-button"),_=u("el-option"),$=u("el-select"),U=u("el-col"),ee=u("el-input"),be=u("el-row"),h=u("el-table-column"),A=u("el-tag"),x=u("el-dropdown-item"),ve=u("el-dropdown-menu"),ye=u("el-dropdown"),we=u("el-table"),he=u("el-pagination"),S=u("el-form-item"),Ce=u("el-form"),le=u("el-dialog"),L=u("el-descriptions-item"),Ve=u("el-descriptions"),Le=De("loading");return c(),v("div",Ze,[z("div",el,[e[15]||(e[15]=z("h2",null,"NLSQL 任务管理",-1)),a(T,{type:"primary",onClick:ne},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Ne))]),_:1}),e[14]||(e[14]=s(" 创建任务 ",-1))]),_:1})]),z("div",ll,[a(be,{gutter:20},{default:o(()=>[a(U,{span:6},{default:o(()=>[a($,{modelValue:w.status,"onUpdate:modelValue":e[0]||(e[0]=t=>w.status=t),placeholder:"任务状态",clearable:"",onChange:m},{default:o(()=>[a(_,{label:"全部",value:""}),a(_,{label:"初始化",value:1}),a(_,{label:"提取元数据",value:2}),a(_,{label:"生成表提示词",value:3}),a(_,{label:"生成字段提示词",value:4}),a(_,{label:"完成",value:5})]),_:1},8,["modelValue"])]),_:1}),a(U,{span:6},{default:o(()=>[a($,{modelValue:w.llm_config_id,"onUpdate:modelValue":e[1]||(e[1]=t=>w.llm_config_id=t),placeholder:"LLM配置",clearable:"",onChange:m},{default:o(()=>[a(_,{label:"全部",value:""}),(c(!0),v(D,null,N(R.value,t=>(c(),C(_,{key:t.id,label:t.provider||`LLM-${t.id}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(U,{span:6},{default:o(()=>[a($,{modelValue:w.db_config_id,"onUpdate:modelValue":e[2]||(e[2]=t=>w.db_config_id=t),placeholder:"数据库配置",clearable:"",onChange:m},{default:o(()=>[a(_,{label:"全部",value:""}),(c(!0),v(D,null,N(P.value,t=>(c(),C(_,{key:t.id,label:t.database_name||`DB-${t.id}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(U,{span:6},{default:o(()=>[a(ee,{modelValue:w.description,"onUpdate:modelValue":e[3]||(e[3]=t=>w.description=t),placeholder:"搜索任务描述...",clearable:"",onChange:m},{prefix:o(()=>[a(r,null,{default:o(()=>[a(y(Me))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),z("div",al,[ze((c(),C(we,{data:K.value,style:{width:"100%"}},{default:o(()=>[a(h,{prop:"id",label:"任务ID",width:"80"}),a(h,{prop:"description",label:"任务描述","min-width":"200","show-overflow-tooltip":""}),a(h,{prop:"llm_config_name",label:"LLM配置",width:"150"}),a(h,{prop:"db_config_name",label:"数据库配置",width:"150"}),a(h,{prop:"user_prompt_config_name",label:"提示词配置",width:"150"}),a(h,{prop:"status",label:"状态",width:"120"},{default:o(({row:t})=>[a(A,{type:W(t.status)},{default:o(()=>[s(g(X(t.status)),1)]),_:2},1032,["type"])]),_:1}),a(h,{prop:"created_at",label:"创建时间",width:"180"},{default:o(({row:t})=>[s(g(B(t.created_at)),1)]),_:1}),a(h,{prop:"updated_at",label:"更新时间",width:"180"},{default:o(({row:t})=>[s(g(B(t.updated_at)),1)]),_:1}),a(h,{label:"操作",width:"120",fixed:"right"},{default:o(({row:t})=>[a(ye,{trigger:"click",onCommand:Te=>re(Te,t)},{dropdown:o(()=>[a(ve,null,{default:o(()=>[a(x,{command:"view"},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Se))]),_:1}),e[17]||(e[17]=s(" 详情 ",-1))]),_:1}),a(x,{command:"scan",disabled:d.value.includes(t.id)},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Pe))]),_:1}),e[18]||(e[18]=s(" 提取元数据 ",-1))]),_:1},8,["disabled"]),a(x,{command:"generateTablePrompt",disabled:d.value.includes(t.id)},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Re))]),_:1}),e[19]||(e[19]=s(" 生成表级别提示词 ",-1))]),_:1},8,["disabled"]),a(x,{command:"generateFieldPrompt",disabled:d.value.includes(t.id)},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Be))]),_:1}),e[20]||(e[20]=s(" 生成字段提示词 ",-1))]),_:1},8,["disabled"]),a(x,{command:"generateRelationPrompt",disabled:d.value.includes(t.id)},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Ue))]),_:1}),e[21]||(e[21]=s(" 生成关联关系提示词 ",-1))]),_:1},8,["disabled"]),a(x,{command:"edit"},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Oe))]),_:1}),e[22]||(e[22]=s(" 编辑 ",-1))]),_:1}),a(x,{command:"delete",divided:""},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Ie))]),_:1}),e[23]||(e[23]=s(" 删除 ",-1))]),_:1})]),_:2},1024)]),default:o(()=>[a(T,{type:"primary",size:"small",loading:d.value.includes(t.id),text:""},{default:o(()=>[a(r,null,{default:o(()=>[a(y(Ee))]),_:1}),e[16]||(e[16]=s(" 操作 ",-1))]),_:1},8,["loading"])]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])),[[Le,O.value]]),z("div",tl,[a(he,{"current-page":b.page,"onUpdate:currentPage":e[4]||(e[4]=t=>b.page=t),"page-size":b.page_size,"onUpdate:pageSize":e[5]||(e[5]=t=>b.page_size=t),"page-sizes":[10,20,50,100],total:b.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:me,onCurrentChange:ge},null,8,["current-page","page-size","total"])])]),a(le,{modelValue:M.value,"onUpdate:modelValue":e[12]||(e[12]=t=>M.value=t),title:V.value?"编辑NLSQL任务":"创建NLSQL任务",width:"800px",onOpen:Y},{footer:o(()=>[a(T,{onClick:e[11]||(e[11]=t=>M.value=!1)},{default:o(()=>[...e[25]||(e[25]=[s("取消",-1)])]),_:1}),a(T,{type:"primary",onClick:se,loading:I.value},{default:o(()=>[s(g(V.value?"更新":"确定"),1)]),_:1},8,["loading"])]),default:o(()=>[a(Ce,{model:n,rules:ae,ref_key:"taskFormRef",ref:k,"label-width":"120px"},{default:o(()=>[a(S,{label:"任务描述",prop:"description"},{default:o(()=>[a(ee,{modelValue:n.description,"onUpdate:modelValue":e[6]||(e[6]=t=>n.description=t),placeholder:"请输入任务描述",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),a(S,{label:"数据库连接",prop:"db_config_id"},{default:o(()=>[a($,{modelValue:n.db_config_id,"onUpdate:modelValue":e[7]||(e[7]=t=>n.db_config_id=t),placeholder:"请选择数据库连接",style:{width:"100%"},onChange:Z},{default:o(()=>[(c(!0),v(D,null,N(P.value,t=>(c(),C(_,{key:t.id,label:`${t.database_name} (${t.type})`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n.db_config_id?(c(),C(S,{key:0,label:"选择表",prop:"select_tables"},{default:o(()=>[a($,{modelValue:n.select_tables,"onUpdate:modelValue":e[8]||(e[8]=t=>n.select_tables=t),placeholder:"搜索并选择要使用的表",style:{width:"100%"},multiple:"",filterable:"",remote:"","remote-method":te,loading:q.value,clearable:""},{default:o(()=>[(c(!0),v(D,null,N(E.value,t=>(c(),C(_,{key:t.id,label:t.table_name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),e[24]||(e[24]=z("div",{style:{"margin-top":"5px",color:"#909399","font-size":"12px"}}," 可搜索表名称并选择多个表，用于NLSQL查询 ",-1))]),_:1})):Q("",!0),a(S,{label:"LLM配置",prop:"llm_config_id"},{default:o(()=>[a($,{modelValue:n.llm_config_id,"onUpdate:modelValue":e[9]||(e[9]=t=>n.llm_config_id=t),placeholder:"请选择LLM配置",style:{width:"100%"}},{default:o(()=>[(c(!0),v(D,null,N(R.value,t=>(c(),C(_,{key:t.id,label:`${t.provider} - ${t.base_url}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(S,{label:"提示词配置",prop:"user_prompt_config_id"},{default:o(()=>[a($,{modelValue:n.user_prompt_config_id,"onUpdate:modelValue":e[10]||(e[10]=t=>n.user_prompt_config_id=t),placeholder:"请选择提示词配置",style:{width:"100%"}},{default:o(()=>[(c(!0),v(D,null,N(j.value,t=>(c(),C(_,{key:t.id,label:t.config_name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(le,{modelValue:F.value,"onUpdate:modelValue":e[13]||(e[13]=t=>F.value=t),title:"任务详情",width:"900px"},{default:o(()=>[p.value?(c(),v("div",ol,[a(Ve,{column:2,border:""},{default:o(()=>[a(L,{label:"任务ID"},{default:o(()=>[s(g(p.value.id),1)]),_:1}),a(L,{label:"任务描述"},{default:o(()=>[s(g(p.value.description||"-"),1)]),_:1}),a(L,{label:"LLM配置"},{default:o(()=>[s(g(p.value.llm_config_name),1)]),_:1}),a(L,{label:"数据库配置"},{default:o(()=>[s(g(p.value.db_config_name),1)]),_:1}),a(L,{label:"提示词配置"},{default:o(()=>[s(g(p.value.user_prompt_config_name),1)]),_:1}),a(L,{label:"状态"},{default:o(()=>[a(A,{type:W(p.value.status)},{default:o(()=>[s(g(X(p.value.status)),1)]),_:1},8,["type"])]),_:1}),a(L,{label:"创建时间"},{default:o(()=>[s(g(B(p.value.created_at)),1)]),_:1}),a(L,{label:"更新时间"},{default:o(()=>[s(g(B(p.value.updated_at)),1)]),_:1})]),_:1}),p.value.select_tables&&p.value.select_tables.length>0?(c(),v("div",nl,[e[26]||(e[26]=z("h4",{style:{"margin-top":"20px","margin-bottom":"10px"}},"选中的表",-1)),(c(!0),v(D,null,N(p.value.select_tables,t=>(c(),C(A,{key:t,style:{"margin-right":"10px","margin-bottom":"10px"}},{default:o(()=>[s(" 表ID: "+g(t),1)]),_:2},1024))),128))])):Q("",!0)])):Q("",!0)]),_:1},8,["modelValue"])])}}},gl=$e(il,[["__scopeId","data-v-297df3cd"]]);export{gl as default};
