import{_ as re,f as ce,c as n,a as l,h as g,w as _,i as d,b as h,g as ie,F as k,x as q,J as ue,K as de,E as x,j as v,r as m,k as _e,L as ye,o as a,n as y,t as c,M as pe}from"./index-CPm_9BR3.js";import{g as ve}from"./nlsqlTaskConfig-vN1Wt6V1.js";import{g as be,a as fe}from"./taskChat-HVpWljCA.js";import"./index-DefhRm7t.js";const ge={class:"test-chat-page"},he={class:"card"},ke={class:"chat-header"},qe={class:"header-actions"},me={class:"session-title-row"},xe={class:"conversation-box"},we={key:0,class:"empty-tip"},Se={class:"message-bubble"},Ce={class:"message-role"},Te={class:"message-content"},De={key:0,class:"sql-block"},Ve={class:"sql-content"},$e={key:1,class:"sql-data-block"},je={key:1,class:"sql-content"},Ae={key:2,class:"sql-data-block"},Ie={class:"selected-table-list"},Ne={key:0,class:"ctx-row"},ze={class:"ctx-value"},Oe={key:1,class:"ctx-row"},Qe={class:"ctx-value"},Ee={key:3,class:"sql-data-block"},Re={class:"query-context-block"},Le={key:0,class:"ctx-row"},Pe={class:"ctx-value"},Be={key:1,class:"ctx-row"},Me={class:"ctx-tag-list"},Je={key:2,class:"ctx-row"},Ke={class:"ctx-join-list"},Ue={key:3,class:"ctx-row"},Fe={class:"sql-content"},He={key:4,class:"sql-data-block"},We={class:"query-context-block"},Ge={key:0,class:"ctx-row"},Xe={class:"ctx-tag-list"},Ye={key:1,class:"ctx-row"},Ze={class:"patch-list"},et={class:"patch-title"},tt={key:0,class:"patch-line"},st={key:1,class:"patch-line"},lt={key:5,class:"message-time"},at={class:"ask-row"},nt={__name:"Test",setup(ot){const $=ye(),j=v([]),b=v(null),z=v(null),w=v(!1),f=v(null),T=v(""),S=v(""),A=v(!1),C=v([]),K=()=>{w.value=!0},U=async()=>{try{const t=await ve({page:1,page_size:100});j.value=t.items||[]}catch{x.error("获取任务列表失败")}},F=async t=>{try{const i=((await be(t,{page:1,page_size:100})).data||[]).slice().reverse(),o=[];i.forEach((u,I)=>{o.push({localId:`${u.id}-u-${I}`,role:"user",content:u.question,created_at:u.created_at}),u.answer&&o.push({localId:`${u.id}-a-${I}`,role:"assistant",content:u.answer,created_at:u.created_at,sql_generated:u.sql_generated,sql_data:u.sql_data,selected_tables:u.selected_tables,select_table_result:u.select_table_result,query_context:u.query_context,q_column_patch:u.column_patch})}),C.value=o}catch(e){x.error(e.response?.data?.detail||"加载历史会话失败")}},H=async()=>{const t=Number($.query.task_id),e=Number($.query.session_id),i=typeof $.query.session_title=="string"?$.query.session_title:"";if(t){const o=j.value.find(u=>u.id===t);o&&(b.value=o,z.value=o.id)}e&&t&&(f.value=e,T.value=i||"",await F(e),x.success(`已载入会话 #${e}，可继续提问`))},W=t=>{const e=j.value.find(i=>i.id===t);e&&(b.value=e,E(),w.value=!1)},E=()=>{f.value=null,C.value=[],S.value="",x.success("已切换到新会话")},R=async()=>{if(!b.value){w.value=!0,x.warning("请先选择任务ID");return}if(!S.value.trim()){x.warning("请输入问题");return}const t=S.value.trim();C.value.push({localId:`${Date.now()}-u`,role:"user",content:t,created_at:new Date().toISOString()}),S.value="";try{A.value=!0;const e={task_id:b.value.id,question:t};f.value?e.session_id=f.value:T.value.trim()&&(e.session_title=T.value.trim());const o=(await fe(e)).data;f.value=o?.session?.id||f.value,C.value.push({localId:`${Date.now()}-a`,role:"assistant",content:o?.conversation?.answer||"未返回回答内容",created_at:o?.conversation?.created_at,sql_generated:o?.conversation?.sql_generated,sql_data:o?.conversation?.sql_data,selected_tables:o?.conversation?.selected_tables,select_table_result:o?.select_table_result,query_context:o?.conversation?.query_context||o?.query_context||o?.select_table_result?.query_context,q_column_patch:o?.qColumnPatch||o?.column_patch||o?.conversation?.column_patch})}catch(e){x.error(e.response?.data?.detail||"问答失败")}finally{A.value=!1}},G=t=>t?new Date(t).toLocaleString("zh-CN"):"",L=t=>{if(typeof t=="string")return t;try{return JSON.stringify(t,null,2)}catch{return String(t)}},D=t=>Object.prototype.toString.call(t)==="[object Object]",O=t=>Array.isArray(t)?t:D(t)?[t]:[],X=t=>{const e=O(t);return e.length>0&&e.every(i=>D(i))},Y=t=>{const e=O(t),i=new Set;return e.forEach(o=>{Object.keys(o).forEach(u=>i.add(u))}),Array.from(i)},P=t=>Array.isArray(t)?t:[],Q=t=>{if(!t)return{};if(typeof t=="string")try{return JSON.parse(t)}catch{return{}}return D(t)?t:{}},B=t=>{const e=P(t?.selected_tables);return e.length>0?e:P(Q(t?.select_table_result).selected_tables)},Z=t=>B(t).length>0,M=t=>{const e=Q(t?.select_table_result).reason;return typeof e=="string"&&e.trim()?e:""},J=t=>{const e=Q(t?.select_table_result).candidate_count;return typeof e=="number"?e:null},p=t=>{if(!t)return{};if(typeof t=="string")try{return JSON.parse(t)}catch{return{}}return D(t)?t:{}},ee=t=>{const e=p(t);return!!(e.driver_table||Array.isArray(e.allowed_tables)&&e.allowed_tables.length>0||Array.isArray(e.joins)&&e.joins.length>0||e.table_usage&&Object.keys(e.table_usage).length>0)},V=t=>{if(!t)return{};if(typeof t=="string")try{return JSON.parse(t)}catch{return{}}return D(t)?t:{}},te=t=>{const e=V(t),i=Array.isArray(e.tables)&&e.tables.length>0,o=e.column_patches&&Object.keys(e.column_patches).length>0;return!!(i||o)};return ce(()=>{U().then(()=>{H()})}),(t,e)=>{const i=m("el-tag"),o=m("el-button"),u=m("el-input"),I=m("el-table-column"),se=m("el-table"),le=m("el-option"),ae=m("el-select"),ne=m("el-dialog"),oe=_e("loading");return a(),n("div",ge,[l("div",he,[l("div",ke,[e[6]||(e[6]=l("div",null,[l("h2",{class:"card-title"},"测试问答"),l("p",{class:"page-desc"},"基于任务会话进行 AI 问答，自动记录历史对话")],-1)),l("div",qe,[b.value?(a(),g(i,{key:0,type:"success"},{default:_(()=>[y("任务ID: "+c(b.value.id),1)]),_:1})):d("",!0),f.value?(a(),g(i,{key:1,type:"info"},{default:_(()=>[y("会话ID: "+c(f.value),1)]),_:1})):d("",!0),h(o,{onClick:K},{default:_(()=>[y(c(b.value?"切换任务":"选择任务"),1)]),_:1}),h(o,{type:"primary",onClick:E,disabled:!b.value},{default:_(()=>[...e[5]||(e[5]=[y("新建会话",-1)])]),_:1},8,["disabled"])])]),l("div",me,[h(u,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=s=>T.value=s),placeholder:"会话标题（可选，首次提问时使用）",clearable:""},null,8,["modelValue"])]),ie((a(),n("div",xe,[C.value.length===0?(a(),n("div",we," 请选择任务并输入问题开始会话 ")):d("",!0),(a(!0),n(k,null,q(C.value,s=>(a(),n("div",{key:s.localId,class:pe(["message-row",s.role])},[l("div",Se,[l("div",Ce,c(s.role==="user"?"我":"AI"),1),l("div",Te,c(s.content),1),s.role==="assistant"&&s.sql_generated?(a(),n("div",De,[e[7]||(e[7]=l("div",{class:"sql-label"},"SQL",-1)),l("pre",Ve,c(s.sql_generated),1)])):d("",!0),s.role==="assistant"&&s.sql_data!==void 0&&s.sql_data!==null?(a(),n("div",$e,[e[8]||(e[8]=l("div",{class:"sql-label"},"SQL Data",-1)),X(s.sql_data)?(a(),g(se,{key:0,data:O(s.sql_data),size:"small",border:"","max-height":"300",class:"sql-table"},{default:_(()=>[(a(!0),n(k,null,q(Y(s.sql_data),r=>(a(),g(I,{key:r,prop:r,label:r,"min-width":"140","show-overflow-tooltip":""},null,8,["prop","label"]))),128))]),_:2},1032,["data"])):(a(),n("pre",je,c(L(s.sql_data)),1))])):d("",!0),s.role==="assistant"&&Z(s)?(a(),n("div",Ae,[e[11]||(e[11]=l("div",{class:"sql-label"},"Selected Tables",-1)),l("div",Ie,[(a(!0),n(k,null,q(B(s),r=>(a(),g(i,{key:`${r.table_id}-${r.table_name}`,type:"warning",effect:"plain",class:"selected-table-tag"},{default:_(()=>[y(c(r.table_name||"-")+" (ID: "+c(r.table_id??"-")+") ",1)]),_:2},1024))),128))]),M(s)?(a(),n("div",Ne,[e[9]||(e[9]=l("span",{class:"ctx-key"},"reason:",-1)),l("span",ze,c(M(s)),1)])):d("",!0),J(s)!==null?(a(),n("div",Oe,[e[10]||(e[10]=l("span",{class:"ctx-key"},"candidate_count:",-1)),l("span",Qe,c(J(s)),1)])):d("",!0)])):d("",!0),s.role==="assistant"&&ee(s.query_context)?(a(),n("div",Ee,[e[16]||(e[16]=l("div",{class:"sql-label"},"Query Context",-1)),l("div",Re,[p(s.query_context).driver_table?(a(),n("div",Le,[e[12]||(e[12]=l("span",{class:"ctx-key"},"driver_table:",-1)),l("span",Pe,c(p(s.query_context).driver_table),1)])):d("",!0),p(s.query_context).allowed_tables?.length?(a(),n("div",Be,[e[13]||(e[13]=l("span",{class:"ctx-key"},"allowed_tables:",-1)),l("div",Me,[(a(!0),n(k,null,q(p(s.query_context).allowed_tables,r=>(a(),g(i,{key:`allowed-${r}`,size:"small",effect:"plain"},{default:_(()=>[y(c(r),1)]),_:2},1024))),128))])])):d("",!0),p(s.query_context).joins?.length?(a(),n("div",Je,[e[14]||(e[14]=l("span",{class:"ctx-key"},"joins:",-1)),l("div",Ke,[(a(!0),n(k,null,q(p(s.query_context).joins,(r,N)=>(a(),n("div",{key:`join-${N}`,class:"ctx-join-item"},c(r.from||"-")+" -> "+c(r.to||"-"),1))),128))])])):d("",!0),p(s.query_context).table_usage?(a(),n("div",Ue,[e[15]||(e[15]=l("span",{class:"ctx-key"},"table_usage:",-1)),l("pre",Fe,c(L(p(s.query_context).table_usage)),1)])):d("",!0)])])):d("",!0),s.role==="assistant"&&te(s.q_column_patch)?(a(),n("div",He,[e[21]||(e[21]=l("div",{class:"sql-label"},"Q Column Patch",-1)),l("div",We,[V(s.q_column_patch).tables?.length?(a(),n("div",Ge,[e[17]||(e[17]=l("span",{class:"ctx-key"},"tables:",-1)),l("div",Xe,[(a(!0),n(k,null,q(V(s.q_column_patch).tables,r=>(a(),g(i,{key:`patch-table-${r}`,size:"small",effect:"plain"},{default:_(()=>[y(c(r),1)]),_:2},1024))),128))])])):d("",!0),V(s.q_column_patch).column_patches?(a(),n("div",Ye,[e[20]||(e[20]=l("span",{class:"ctx-key"},"column_patches:",-1)),l("div",Ze,[(a(!0),n(k,null,q(V(s.q_column_patch).column_patches,(r,N)=>(a(),n("div",{key:`patch-${N}`,class:"patch-item"},[l("div",et,c(N),1),r?.where?(a(),n("div",tt,[e[18]||(e[18]=l("b",null,"WHERE:",-1)),y(" "+c(r.where),1)])):d("",!0),r?.reason?(a(),n("div",st,[e[19]||(e[19]=l("b",null,"REASON:",-1)),y(" "+c(r.reason),1)])):d("",!0)]))),128))])])):d("",!0)])])):d("",!0),s.created_at?(a(),n("div",lt,c(G(s.created_at)),1)):d("",!0)])],2))),128))])),[[oe,A.value]]),l("div",at,[h(u,{modelValue:S.value,"onUpdate:modelValue":e[1]||(e[1]=s=>S.value=s),type:"textarea",rows:3,placeholder:"请输入你的问题",onKeydown:ue(de(R,["ctrl","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),h(o,{type:"primary",class:"send-btn",loading:A.value,onClick:R},{default:_(()=>[...e[22]||(e[22]=[y("发送",-1)])]),_:1},8,["loading"])])]),h(ne,{modelValue:w.value,"onUpdate:modelValue":e[4]||(e[4]=s=>w.value=s),title:"选择任务",width:"680px"},{footer:_(()=>[h(o,{onClick:e[3]||(e[3]=s=>w.value=!1)},{default:_(()=>[...e[23]||(e[23]=[y("关闭",-1)])]),_:1})]),default:_(()=>[h(ae,{modelValue:z.value,"onUpdate:modelValue":e[2]||(e[2]=s=>z.value=s),filterable:"",clearable:"",placeholder:"搜索并选择任务",style:{width:"100%"},onChange:W},{default:_(()=>[(a(!0),n(k,null,q(j.value,s=>(a(),g(le,{key:s.id,label:`${s.id} - ${s.description||"无描述"}`,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}},dt=re(nt,[["__scopeId","data-v-5f3b5cc4"]]);export{dt as default};
